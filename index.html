<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‚Ä¢ Simple & Personal</title>
  <meta name="color-scheme" content="light only">
  <meta name="description" content="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{ --from:#0f0c29; --mid:#302b63; --to:#24243e; --primary:#6366f1; --secondary:#8b5cf6; --success:#10b981; --warn:#f59e0b; --danger:#ef4444; --ring:#e5e7eb; }
    html,body{height:100%}
    body{ margin:0; padding:0; box-sizing:border-box; font-family:'Inter','Noto Sans Thai',system-ui,-apple-system,'Segoe UI',sans-serif; background:linear-gradient(135deg,var(--from) 0%,var(--mid) 50%,var(--to) 100%); }
    .glass{ background:rgba(255,255,255,.94); backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,.35) }
    .btn{ position:relative; overflow:hidden; transition:transform .2s ease, box-shadow .2s ease }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(99,102,241,.35) }
    .mono{ font-variant-numeric:tabular-nums }
    .chip{ display:inline-block; padding:.15rem .5rem; border-radius:.5rem; background:#f1f5f9; font-weight:700 }
    .grid-auto{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:.75rem }
    .ring-anim{ transition:stroke-dashoffset .9s cubic-bezier(.2,.8,.2,1) }
    @media (prefers-reduced-motion:reduce){ *{ animation-duration:.001ms !important; animation-iteration-count:1 !important; transition-duration:.001ms !important; scroll-behavior:auto !important } }
    input[data-money]{ outline:none } td input{ text-align:right }
    .sr{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }

    /* ===== Print styles for clean PDF ===== */
    .no-print{ }
    @media print{
      body{ background:#fff !important; }
      #progressContainer, #welcomeScreen, #questionScreen, #toastRoot { display:none !important; }
      #finalScreen{ display:block !important; }
      .no-print{ display:none !important; }
      .glass{ background:#fff !important; border:0 !important; backdrop-filter:none !important; box-shadow:none !important; }
      .print-container{ box-shadow:none !important; }
      *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
      .page-break-avoid{ break-inside:avoid; }
      .page-break{ page-break-before:always; }
    }
  </style>
</head>
<body class="min-h-full">
  <!-- decorations -->
  <div aria-hidden="true" class="pointer-events-none select-none no-print">
    <div class="absolute top-20 left-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply blur-3xl opacity-20"></div>
    <div class="absolute top-40 right-10 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply blur-3xl opacity-20"></div>
    <div class="absolute -bottom-20 left-1/2 w-72 h-72 bg-indigo-500 rounded-full mix-blend-multiply blur-3xl opacity-20"></div>
  </div>

  <main class="relative z-10 min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-3xl print-container">
      <!-- Progress -->
      <div id="progressContainer" class="mb-6 hidden" aria-live="polite">
        <div class="flex justify-between items-center mb-2">
          <span class="text-white/80 text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
          <span id="progressText" class="text-white text-sm font-bold">0%</span>
        </div>
        <div class="bg-white/15 rounded-full h-2 overflow-hidden backdrop-blur">
          <div id="progressBar" class="h-2 rounded-full" style="width:0%;background:linear-gradient(90deg,var(--primary),var(--secondary))"></div>
        </div>
      </div>

      <div class="glass rounded-3xl shadow-2xl p-6 sm:p-8">
        <!-- Welcome -->
        <section id="welcomeScreen">
          <div class="text-center">
            <div class="inline-block p-6 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-3xl mb-6 shadow-2xl" aria-hidden="true">
              <div class="text-6xl">üí∞</div>
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-3" style="background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
            <p class="text-gray-600 mb-3 sm:mb-4 text-base sm:text-lg font-medium max-w-md mx-auto">‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ä‡∏±‡∏î‡πÜ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á</p>
            <p class="text-xs text-gray-400 max-w-md mx-auto mb-6">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
            <div class="grid gap-3 sm:gap-4">
              <button id="btnStart" data-action="start" class="btn px-6 py-4 sm:px-10 sm:py-5 rounded-2xl text-white font-bold text-base sm:text-lg shadow-xl" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‚Üí</button>
              <button id="btnResume" data-action="resume" class="btn px-6 py-4 rounded-2xl font-semibold text-gray-800 bg-white border border-gray-200 hidden">‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô</button>
            </div>
          </div>
        </section>

        <!-- Questions -->
        <section id="questionScreen" class="hidden" aria-live="polite"><div id="questionContent"></div></section>
        <!-- Final -->
        <section id="finalScreen" class="hidden"><div id="finalContent"></div></section>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toastRoot" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-[9999] no-print" aria-live="assertive" aria-atomic="true"></div>

  <script>
    /* ===== Helpers ===== */
    var moneyFmt = new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 });
    function thb(n){ return moneyFmt.format(Math.round(isFinite(n)? n:0)); }
    function buzz(ms){ if(ms===void 0) ms=12; if(navigator.vibrate) navigator.vibrate(ms); }
    function $(id){ return document.getElementById(id); }

    function toast(msg, type){
      if(type===void 0) type='info';
      var root=$('toastRoot'); if(!root) return;
      var el=document.createElement('div');
      el.className='px-4 py-3 rounded-xl text-white shadow-lg mb-2';
      el.style.background= type==='success'?'#10b981': type==='warn'?'#f59e0b': type==='error'?'#ef4444':'#6366f1';
      el.textContent= String(msg); root.appendChild(el);
      setTimeout(function(){ el.style.opacity=.0; el.style.transform='translateY(6px)'; },1600);
      setTimeout(function(){ root.removeChild(el); },2200);
    }

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å value ‡πÄ‡∏™‡∏°‡∏≠ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á = 0)
    function parseMoneyInput(el){
      if(!el) return 0;
      var raw = (el.value||'').toString().replace(/,/g,'').trim();
      if(raw==='') return 0;
      var n = Number(raw);
      return (isFinite(n) && n>=0) ? n : 0;
    }

    // formatter
    document.addEventListener('input', function(e){
      var t=e.target;
      if(t && t.matches && t.matches('input[data-money]')){
        var cleaned = t.value.replace(/[^\d.]/g,'').replace(/(\..*?)\..*/,'$1');
        if(cleaned===''){ t.value=''; return; }
        var parts = cleaned.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        t.value = parts.join('.');
      }
    });

    /* ===== Data ===== */
    var currentStep=0;
    var userData = { income:0, debtExpense:0, expenses:{}, savings:0 };

    var expenseCategories = [
      { key:'food', label:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon:'üçú', need:true },
      { key:'transport', label:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', icon:'üöó', need:true },
      { key:'household', label:'‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', icon:'üè†', need:false },
      { key:'utilities', label:'‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü', icon:'üí°', need:true },
      { key:'entertainment', label:'‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå/‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á', icon:'üéâ', need:false },
      { key:'clothing', label:'‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', icon:'üëî', need:false },
      { key:'internet', label:'‡πÄ‡∏ô‡πá‡∏ï/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', icon:'üì±', need:true },
      { key:'other', label:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon:'üìù', need:false }
    ];

    var questions = [
      { id:'income',   title:'‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon:'üíµ', desc:'‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‚Äù ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single', field:'income' },
      { id:'debt',     title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon:'üí≥', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô/‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single', field:'debtExpense' },
      { id:'expenses', title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î)', icon:'üõí', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'multiple', field:'expenses' },
      { id:'savings',  title:'‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', icon:'üè¶', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà', type:'single', field:'savings' }
    ];

    /* ===== Autosave ===== */
    var SAVE_KEY='finhealth:simple:v3'; var qs=new URLSearchParams(location.search);
    function loadState(){
      try{
        if(qs.get('s')){ userData = JSON.parse(decodeURIComponent(atob(qs.get('s')))); return true; }
        var raw=localStorage.getItem(SAVE_KEY); if(raw){ userData=JSON.parse(raw); return true; }
      }catch(e){}
      return false;
    }
    function persist(){
      var minimal = {
        income:userData.income, debtExpense:userData.debtExpense, expenses:userData.expenses,
        savings:userData.savings, results:userData.results||null, planTargets:userData.planTargets||null
      };
      try{ localStorage.setItem(SAVE_KEY, JSON.stringify(minimal)); }catch(e){}
    }
    var debounce=(function(fn){ var t; return function(){ clearTimeout(t); t=setTimeout(fn,300); }; })(persist);

    /* ===== Flow ===== */
    function setProgress(i,total){
      var p=Math.max(0,Math.min(100,Math.round(i/total*100)));
      var bar=$('progressBar'); if(bar) bar.style.width=p+'%';
      var txt=$('progressText'); if(txt) txt.textContent=p+'%';
    }
    function start(){
      var w=$('welcomeScreen'); if(w) w.classList.add('hidden');
      var pc=$('progressContainer'); if(pc) pc.classList.remove('hidden');
      currentStep=0; renderQuestion();
    }
    function prev(){ if(currentStep>0){ currentStep--; renderQuestion(); debounce(); } }
    function moneyInput(id, placeholder){ if(placeholder===void 0) placeholder='0';
      return '<input type="text" id="'+id+'" data-money class="w-full px-6 py-4 border-0 rounded-2xl text-xl font-semibold text-gray-800 mono" placeholder="'+placeholder+'" inputmode="decimal" aria-label="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">'; }

    function renderQuestion(){
      var q=questions[currentStep];
      var totalSteps=questions.length;
      setProgress(currentStep+1,totalSteps);
      var qsEl=$('questionScreen'); if(qsEl) qsEl.classList.remove('hidden');
      var fs=$('finalScreen'); if(fs) fs.classList.add('hidden');

      if(q.type==='single'){
        $('questionContent').innerHTML =
          '<div class="text-center mb-6">'+
            '<div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4" aria-hidden="true"><div class="text-5xl">'+q.icon+'</div></div>'+
            '<h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">'+q.title+'</h2>'+
            '<p class="text-gray-600 font-medium">'+q.desc+'</p>'+
          '</div>'+
          '<label class="sr" for="money_single">'+q.title+'</label>'+
          '<div class="mb-6">'+moneyInput('money_single')+'</div>'+
          '<div class="flex gap-3">'+
            (currentStep>0?'<button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>':'')+
            '<button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>'+
          '</div>';
        var el=$('money_single'); var val=userData[q.field]||0; if(val){ el.value=thb(val); }
        if(el) el.focus();
      }else{
        var fields=expenseCategories.map(function(c){
          return '<div>'+
            '<label for="ex_'+c.key+'" class="block text-sm font-bold mb-1 text-gray-700 flex items-center gap-2">'+
              '<span class="text-2xl">'+c.icon+'</span>'+c.label+(c.need?'<span class="text-[10px] ml-2 px-2 py-[2px] rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>':'')+
            '</label>'+ moneyInput('ex_'+c.key) +'</div>';
        }).join('');
        $('questionContent').innerHTML =
          '<div class="text-center mb-5">'+
            '<div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4" aria-hidden="true"><div class="text-5xl">'+q.icon+'</div></div>'+
            '<h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">'+q.title+'</h2>'+
            '<p class="text-gray-600 font-medium">'+q.desc+'</p>'+
          '</div>'+
          '<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-5">'+fields+'</div>'+
          '<div class="flex gap-3">'+
            '<button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>'+
            '<button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>'+
          '</div>';
        expenseCategories.forEach(function(c){
          var el=$('ex_'+c.key); var v=userData.expenses[c.key]||0;
          if(v && el){ el.value=thb(v); }
        });
      }
      var bp=$('btnPrev'); if(bp) bp.addEventListener('click', prev);
      var bn=$('btnNext'); if(bn) bn.addEventListener('click', next);
    }

    function next(){
      var q=questions[currentStep];
      if(q.type==='single'){
        var val=parseMoneyInput($('money_single'));
        if(!isFinite(val) || val<0){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','warn'); return; }
        userData[q.field]=val;
      }else{
        expenseCategories.forEach(function(c){
          var el=$('ex_'+c.key);
          userData.expenses[c.key]= el ? parseMoneyInput(el) : 0;
        });
      }
      currentStep++; debounce();
      if(currentStep<questions.length){ renderQuestion(); } else { computeCore(); }
      buzz();
    }

    /* ===== Core Calculations ===== */
    function safeDiv(a,b){ return b>0 ? a/b : 0; }

    function computeCore(){
      var inc=Math.max(0, userData.income||0);
      var debt=Math.max(0, userData.debtExpense||0);
      var spend=Object.values(userData.expenses||{}).reduce(function(a,b){ return a+Math.max(0,b||0); },0);
      var totalExp=debt+spend;
      var sav=Math.max(0, userData.savings||0);

      var dti=safeDiv(debt,inc)*100;
      var efMonths=safeDiv(sav,totalExp);
      var liquidity=inc-totalExp;

      var dti35=inc*0.35, dti45=inc*0.45;
      var needTo35=Math.max(0,debt-dti35);
      var needTo45=Math.max(0,debt-dti45);
      var needTo3m=Math.max(0,3*totalExp - sav);
      var needTo6m=Math.max(0,6*totalExp - sav);

      var offenders=Object.entries(userData.expenses).map(function(kv){
        var k=kv[0], v=kv[1];
        var cat=null; for(var i=0;i<expenseCategories.length;i++){ if(expenseCategories[i].key===k){ cat=expenseCategories[i]; break; } }
        return { k:k, v:Math.max(0,v||0), label:cat?cat.label:k, need:cat?!!cat.need:false };
      }).filter(function(x){ return x.v>0; }).sort(function(a,b){ return b.v-a.v; });

      var dtiStatus = dti<=35 ? '‡∏î‡∏µ‡∏°‡∏≤‡∏Å' : dti<=45 ? '‡∏£‡∏∞‡∏ß‡∏±‡∏á' : '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢';
      var dtiColor  = dti<=35 ? '#10b981' : dti<=45 ? '#f59e0b' : '#ef4444';
      var efStatus  = efMonths<3 ? '‡πÑ‡∏°‡πà‡∏û‡∏≠' : efMonths<=6 ? '‡∏û‡∏≠' : '‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤';
      var efColor   = efMonths<3 ? '#ef4444' : efMonths<=6 ? '#10b981' : '#3b82f6';
      var liqStatus = liquidity<0 ? '‡∏ï‡∏¥‡∏î‡∏•‡∏ö' : '‡∏î‡∏µ';
      var liqColor  = liquidity<0 ? '#ef4444' : '#10b981';

      var adviceDTI = (function(){
        if(dti<=35) return [
          'DTI = '+dti.toFixed(1)+'% ‚Üí ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏™‡∏ö‡∏≤‡∏¢',
          '‡∏Å‡∏±‡∏ô‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô ‚â•20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (~'+thb(inc*0.20)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)',
          '‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏™‡∏π‡∏á ‡πÇ‡∏õ‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏≠‡∏Å‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô'
        ];
        if(dti<=45) return [
          'DTI = '+dti.toFixed(1)+'% (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á)',
          '‡πÄ‡∏õ‡πâ‡∏≤: ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚â§ '+thb(dti35)+'‡∏ø (‡∏•‡∏î ~'+thb(needTo35)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)',
          '‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏£‡∏µ‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå ‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'
        ];
        return [
          'DTI = '+dti.toFixed(1)+'% (‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)',
          '‡∏î‡πà‡∏ß‡∏ô: ‡∏•‡∏î‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 45% (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ~'+thb(needTo45)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏∏‡πà‡∏á‡πÑ‡∏õ 35% (~'+thb(needTo35)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)',
          '‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏£‡∏ß‡∏°‡∏´‡∏ô‡∏µ‡πâ + ‡∏á‡∏î‡∏Å‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà'
        ];
      })();

      var adviceEF = (function(){
        if(liquidity<0){
          return [
            '‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö ~'+thb(Math.abs(liquidity))+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
            '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏≠‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á ‚â• 0 ‡∏Å‡πà‡∏≠‡∏ô',
            '‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô/‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô'
          ];
        }
        if(efMonths<3) return [
          '‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô '+efMonths.toFixed(1)+' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠)',
          '‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ '+thb(Math.max(1000, Math.round((needTo3m/6)/100)*100))+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
          '‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏ï‡πà‡πÑ‡∏õ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏≤‡∏î ~'+thb(needTo6m)+'‡∏ø)'
        ];
        if(efMonths<=6) return [
          '‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô '+efMonths.toFixed(1)+' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏û‡∏≠‡πÉ‡∏ä‡πâ)',
          '‡∏£‡∏±‡∏Å‡∏©‡∏≤ 3‚Äì6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏π‡∏á',
          '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏¢‡∏Å‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏ö‡∏ö DCA'
        ];
        return [
          '‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô '+efMonths.toFixed(1)+' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤)',
          '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ~'+thb(Math.max(0, sav-6*totalExp))+'‡∏ø ‚Üí ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ',
          '‡∏Ñ‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÑ‡∏ß‡πâ ~6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πá‡∏û‡∏≠'
        ];
      })();

      var adviceLIQ = (function(){
        if(liquidity<0){
          var gap=Math.abs(liquidity);
          var cuts=offenders.filter(function(e){return !e.need;}).slice(0,3)
            .map(function(e,i){ return (i+1)+'. '+e.label+' ‡∏•‡∏î 10‚Äì15% (~'+thb(e.v*0.10)+'‚Äì'+thb(e.v*0.15)+'‡∏ø)'; }).join(' ‚Ä¢ ');
          return [
            '‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö ~'+thb(gap)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
            cuts || '‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô 10‚Äì15% ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß',
            (dti>45 ? '‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏π‡πà: ‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : '‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ')
          ];
        }
        var to6m=Math.max(0, 6*totalExp - sav);
        var efAlloc=Math.min(liquidity,to6m);
        var investAlloc=Math.max(0, liquidity - efAlloc);
        return [
          '‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ß‡∏Å ~'+thb(liquidity)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
          '‡πÅ‡∏ö‡πà‡∏á: ‡πÄ‡∏ï‡∏¥‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ~'+thb(efAlloc)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
          '‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~'+thb(investAlloc)+'‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠'
        ];
      })();

      userData.results = {
        inc:inc, debt:debt, spend:spend, totalExp:totalExp, sav:sav, dti:dti, efMonths:efMonths, liquidity:liquidity,
        dtiStatus:dtiStatus, dtiColor:dtiColor, efStatus:efStatus, efColor:efColor, liqStatus:liqStatus, liqColor:liqColor,
        needTo35:needTo35, needTo45:needTo45, needTo3m:needTo3m, needTo6m:needTo6m, offenders:offenders,
        advice:{ dti:adviceDTI, ef:adviceEF, liq:adviceLIQ }
      };
      debounce();
      renderFinal();
    }

    /* ===== Final + Plan + Emergency Fund Simulator ===== */
    function ring(el, pct, color, label, valueText){
      var R=54, C=2*Math.PI*R, p=Math.max(0,Math.min(100,pct));
      el.innerHTML =
        '<div class="p-4 rounded-2xl bg-white/90 border border-white/60 shadow text-center page-break-avoid">'+
          '<svg width="140" height="140" viewBox="0 0 140 140" class="mx-auto block" role="img" aria-label="'+label+' '+valueText+'">'+
            '<circle cx="70" cy="70" r="'+R+'" stroke="var(--ring)" stroke-width="14" fill="none"></circle>'+
            '<circle cx="70" cy="70" r="'+R+'" stroke="'+color+'" stroke-linecap="round" stroke-width="14" fill="none" class="ring-anim" style="stroke-dasharray:'+C+';stroke-dashoffset:'+C+';transform:rotate(-90deg);transform-origin:50% 50%"></circle>'+
            '<text x="50%" y="50%" text-anchor="middle" dy="8" font-size="22" font-weight="800" fill="'+color+'">'+valueText+'</text>'+
          '</svg>'+
          '<div class="mt-2 font-bold text-gray-800">'+label+'</div>'+
        '</div>';
      var circles = el.querySelectorAll('circle');
      if(circles.length>1){ setTimeout(function(){ circles[1].style.strokeDashoffset = C*(1 - p/100); }, 0); }
    }
    function ul(lines){ return '<ul class="list-disc list-inside text-gray-700 leading-relaxed">'+lines.map(function(x){return '<li>'+x+'</li>';}).join('')+'</ul>'; }

    function editableCapTable(initCaps, data){
      var visibleCats = expenseCategories.filter(function(c){ return (data.expenses[c.key]||0)>0 || (initCaps[c.key]||0)>0; });
      var rows = visibleCats.map(function(c){
        var now=data.expenses[c.key]||0; var rec=(initCaps[c.key]!==undefined?initCaps[c.key]:now);
        return '<tr class="text-sm page-break-avoid">'+
          '<td class="py-2">'+c.icon+' '+c.label+(c.need?'<span class="text-[10px] ml-2 px-2 py-[2px] rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô</span>':'')+'</td>'+
          '<td class="py-2 text-right mono">'+thb(now)+'</td>'+
          '<td class="py-2 text-right"><input data-money data-cap="'+c.key+'" class="w-28 px-2 py-1 rounded-lg border text-right" value="'+thb(rec)+'" aria-label="‡∏õ‡∏£‡∏±‡∏ö '+c.label+'"></td>'+
          '<td class="py-2 text-right mono" id="diff_'+c.key+'"></td>'+
        '</tr>';
      }).join('');
      return '<table class="w-full"><thead>'+
        '<tr class="text-xs text-gray-500 border-b"><th class="py-2 text-left">‡∏´‡∏°‡∏ß‡∏î</th><th class="py-2 text-right">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</th><th class="py-2 text-right">‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á)</th><th class="py-2 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th></tr></thead>'+
        '<tbody>'+rows+'</tbody></table>';
    }

    function incomeDebtTable(R){
      return ''+
      '<div class="grid gap-4">'+
        '<div class="rounded-2xl border p-4 bg-white page-break-avoid">'+
          '<div class="font-semibold mb-2 flex items-center gap-2"><span class="text-xl">üíµ</span>‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>'+
          '<table class="w-full">'+
            '<thead><tr class="text-xs text-gray-500 border-b"><th class="py-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="py-2 text-right">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</th><th class="py-2 text-right">‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á)</th><th class="py-2 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th></tr></thead>'+
            '<tbody>'+
              '<tr class="text-sm">'+
                '<td class="py-2">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</td>'+
                '<td class="py-2 text-right mono">'+thb(R.inc)+'</td>'+
                '<td class="py-2 text-right"><input data-money id="new_income" class="w-32 px-2 py-1 rounded-lg border text-right" placeholder="'+thb(R.inc)+'" aria-label="‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°"></td>'+
                '<td class="py-2 text-right mono" id="diff_income"></td>'+
              '</tr>'+
            '</tbody>'+
          '</table>'+
          '<p class="text-xs text-gray-500 mt-2">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</p>'+
        '</div>'+
        '<div class="rounded-2xl border p-4 bg-white page-break-avoid">'+
          '<div class="font-semibold mb-2 flex items-center gap-2"><span class="text-xl">üí≥</span>‡∏´‡∏°‡∏ß‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</div>'+
          '<table class="w-full">'+
            '<thead><tr class="text-xs text-gray-500 border-b"><th class="py-2 text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="py-2 text-right">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</th><th class="py-2 text-right">‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á)</th><th class="py-2 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th></tr></thead>'+
            '<tbody>'+
              '<tr class="text-sm">'+
                '<td class="py-2">‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</td>'+
                '<td class="py-2 text-right mono">'+thb(R.debt)+'</td>'+
                '<td class="py-2 text-right"><input data-money id="new_debt" class="w-32 px-2 py-1 rounded-lg border text-right" placeholder="'+thb(R.debt)+'" aria-label="‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°"></td>'+
                '<td class="py-2 text-right mono" id="diff_debt"></td>'+
              '</tr>'+
            '</tbody>'+
          </table>'+
          '<p class="text-xs text-gray-500 mt-2">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ = ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</p>'+
        '</div>'+
      '</div>';
    }

    function renderFinal(){
      // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≠‡∏ô
      var pc=$('progressContainer'); if(pc) pc.classList.add('hidden');
      var qs=$('questionScreen'); if(qs) qs.classList.add('hidden');
      var ws=$('welcomeScreen'); if(ws) ws.classList.add('hidden');
      var fs=$('finalScreen'); if(fs) fs.classList.remove('hidden');

      var R=userData.results;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
      var baseShare={ food:.15, transport:.10, household:.06, utilities:.07, entertainment:.05, clothing:.03, internet:.03, other:.06 };
      var floors={ food:3000, transport:800, utilities:500 };
      var spendShareNow=(R.inc>0)?(R.spend/R.inc):.55;
      var targetSpendShare=Math.min(.65, Math.max(.50, spendShareNow||.55));
      var initCaps={};
      Object.keys(baseShare).forEach(function(k){
        var v=baseShare[k]; var now=userData.expenses[k]||0;
        if(now===0){ initCaps[k]=0; return; }
        var cap=Math.round(R.inc*(v/0.55)*targetSpendShare);
        if(floors[k]) cap=Math.max(cap,floors[k]);
        var stepFloor=Math.round(now*0.8);
        initCaps[k]=Math.min(now, Math.max(cap, stepFloor));
      });

      // ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (‡∏ï‡∏¥‡∏î‡πÑ‡∏õ‡∏Å‡∏±‡∏ö PDF)
      var today = new Date();
      var stamp = today.toLocaleDateString('th-TH', { year:'numeric', month:'short', day:'numeric' });

      $('finalContent').innerHTML =
        '<div class="text-center mb-2">'+
          '<div class="inline-block p-5 bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl mb-3" aria-hidden="true"><div class="text-5xl">‚ú®</div></div>'+
          '<h2 class="text-2xl sm:text-3xl font-extrabold" style="background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á)</h2>'+
          '<p class="text-gray-500">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚Ä¢ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ '+stamp+'</p>'+
        '</div>'+
        '<div id="ringRow" class="grid grid-cols-1 sm:grid-cols-3 gap-3 my-4"></div>'+
        '<div class="grid gap-4">'+
          '<div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow page-break-avoid" style="border-color:'+R.dtiColor+'">'+
            '<div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold">‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (DTI)</h3><span class="px-3 py-1 text-xs rounded-full text-white" style="background:'+R.dtiColor+'">'+R.dtiStatus+'</span></div>'+
            '<div class="text-3xl font-extrabold mb-1" style="color:'+R.dtiColor+'">'+R.dti.toFixed(1)+'%</div>'+ ul(R.advice.dti) +
          '</div>'+
          '<div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow page-break-avoid" style="border-color:'+R.efColor+'">'+
            '<div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold">‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h3><span class="px-3 py-1 text-xs rounded-full text-white" style="background:'+R.efColor+'">'+R.efStatus+'</span></div>'+
            '<div class="text-3xl font-extrabold mb-1" style="color:'+R.efColor+'">'+R.efMonths.toFixed(1)+' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>'+ ul(R.advice.ef) +
          '</div>'+
          '<div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow page-break-avoid" style="border-color:'+R.liqColor+'">'+
            '<div class="flex items-center justify-between mb-2"><h3 class="text-lg font-bold">‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3><span class="px-3 py-1 text-xs rounded-full text-white" style="background:'+R.liqColor+'">'+R.liqStatus+'</span></div>'+
            '<div class="text-3xl font-extrabold mb-1" style="color:'+R.liqColor+'">'+thb(R.liquidity)+' ‡∏ø</div>'+ ul(R.advice.liq) +
          '</div>'+
          '<div class="bg-white rounded-2xl p-5 border page-break-avoid">'+
            '<div class="flex items-center gap-2 mb-3"><span class="text-2xl">üßÆ</span><h3 class="text-lg font-bold">‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (3‚Äì6 ‡πÄ‡∏ó‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3></div>'+
            '<div class="grid gap-3 sm:grid-cols-2">'+
              '<div class="rounded-xl border p-3 bg-gray-50">'+
                '<div class="text-sm text-gray-600">‡∏à‡∏∞‡∏≠‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>'+
                '<input data-money id="ef_extra" class="mt-1 w-full px-4 py-3 rounded-xl border bg-white text-right font-bold mono" placeholder="'+thb(Math.max(1000,Math.round((R.needTo3m/6)/100)*100))+'">'+
                '<div class="text-xs text-gray-500 mt-1">‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á = ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>'+
              '</div>'+
              '<div class="rounded-xl border p-3 bg-white">'+
                '<div class="text-sm text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>'+
                '<div class="text-sm">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 3 ‡πÄ‡∏ó‡πà‡∏≤: <span class="font-bold mono">'+thb(3*R.totalExp)+'</span> ‡∏ø ‚Ä¢ ‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà ~ <span class="font-bold mono">'+thb(Math.max(0,3*R.totalExp - R.sav))+'</span> ‡∏ø</div>'+
                '<div class="text-sm">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ 6 ‡πÄ‡∏ó‡πà‡∏≤: <span class="font-bold mono">'+thb(6*R.totalExp)+'</span> ‡∏ø ‚Ä¢ ‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà ~ <span class="font-bold mono">'+thb(Math.max(0,6*R.totalExp - R.sav))+'</span> ‡∏ø</div>'+
              '</div>'+
            '</div>'+
            '<div id="ef_result" class="mt-3 p-3 rounded-xl border bg-white text-sm" aria-live="polite"></div>'+
          </div>'+
          '<div class="bg-white rounded-2xl p-5 border page-break-avoid">'+
            '<div class="flex items-center gap-2 mb-2"><span class="text-2xl" aria-hidden="true">üß≠</span><h3 class="text-lg font-bold">‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö / ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ / ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)</h3></div>'+
            incomeDebtTable(R)+
            '<div class="mt-4 rounded-2xl border p-4 bg-white">'+
              '<div class="font-semibold mb-2">‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î</div>'+
              editableCapTable(initCaps,userData)+
              '<p class="text-xs text-gray-500 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏•‡∏î 10‚Äì20% ‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏£‡∏á‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á</p>'+
              '<div class="mt-3 text-sm p-3 rounded-xl border bg-white" id="planSummary" aria-live="polite"></div>'+
            '</div>'+
          '</div>'+
        '</div>'+
        '<div class="grid gap-3 sm:grid-cols-2 mt-5 no-print">'+
          '<button id="btnRestart" class="btn px-6 py-4 rounded-2xl text-white font-bold" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>'+
          '<button id="btnSavePdf" class="btn px-6 py-4 rounded-2xl font-semibold bg-white border">üñ®Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>'+
        '</div>';

      // ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ
      var row=$('ringRow'); var a=document.createElement('div'), b=document.createElement('div'), c=document.createElement('div'); row.appendChild(a); row.appendChild(b); row.appendChild(c);
      var dtiPct=Math.min(100, R.dti);
      var efPct=Math.min(100,(R.efMonths/6)*100);
      var liqPct=R.liquidity<=0?0:Math.min(100,(R.liquidity/Math.max(1,R.inc))*100);
      ring(a,dtiPct,R.dtiColor,'DTI ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', R.dti.toFixed(1)+'%');
      ring(b,efPct,R.efColor,'‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', R.efMonths.toFixed(1)+'‡∏î.');
      ring(c,liqPct,R.liqColor,'‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á/‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', liqPct.toFixed(0)+'%');

      // ===== Emergency Fund Simulator =====
      function monthsToText(m){
        if(!isFinite(m) || m<=0) return '0 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
        var mm = Math.ceil(m);
        var y = Math.floor(mm/12), mo = mm%12;
        var parts=[];
        if(y>0) parts.push(y+' ‡∏õ‡∏µ');
        if(mo>0) parts.push(mo+' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
        return parts.join(' ');
      }
      function addMonths(date, m){
        var d=new Date(date.getTime());
        var day=d.getDate();
        d.setMonth(d.getMonth()+m);
        if(d.getDate()<day){ d.setDate(0); }
        return d;
      }
      function formatThai(d){
        return d.toLocaleDateString('th-TH',{year:'numeric',month:'short'});
      }
      function efSimRecalc(){
        var extraEl = $('ef_extra');
        var extra = (extraEl && extraEl.value.trim()!=='') ? parseMoneyInput(extraEl) : 0;
        var box = $('ef_result');
        var short3 = Math.max(0, 3*R.totalExp - R.sav);
        var short6 = Math.max(0, 6*R.totalExp - R.sav);

        if(extra<=0){
          box.innerHTML = '<div class="text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‚Äú‡∏≠‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á 3x ‡πÅ‡∏•‡∏∞ 6x</div>';
          return;
        }
        var m3 = short3<=0 ? 0 : (short3/extra);
        var m6 = short6<=0 ? 0 : (short6/extra);
        var now=new Date();
        var done3 = short3<=0 ? '‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : monthsToText(m3)+' ‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì '+formatThai(addMonths(now, Math.ceil(m3)));
        var done6 = short6<=0 ? '‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : monthsToText(m6)+' ‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì '+formatThai(addMonths(now, Math.ceil(m6)));

        box.innerHTML =
          '<div class="grid gap-2 sm:grid-cols-2">'+
            '<div class="rounded-lg border p-3 bg-emerald-50">'+
              '<div class="text-xs text-emerald-700">‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 3 ‡πÄ‡∏ó‡πà‡∏≤</div>'+
              '<div class="font-extrabold mono text-emerald-800">'+done3+'</div>'+
              '<div class="text-xs text-emerald-700">‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà ~ '+thb(short3)+' ‡∏ø</div>'+
            '</div>'+
            '<div class="rounded-lg border p-3 bg-indigo-50">'+
              '<div class="text-xs text-indigo-700">‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á 6 ‡πÄ‡∏ó‡πà‡∏≤</div>'+
              '<div class="font-extrabold mono text-indigo-800">'+done6+'</div>'+
              '<div class="text-xs text-indigo-700">‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà ~ '+thb(short6)+' ‡∏ø</div>'+
            '</div>'+
          '</div>';
      }

      var extraEl=$('ef_extra'); if(extraEl){ extraEl.addEventListener('input', efSimRecalc); }

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô
      function recalcPlan(){
        var targets={}, newSpend=0;

        expenseCategories.forEach(function(c){
          var now=userData.expenses[c.key]||0;
          var inp=document.querySelector('[data-cap="'+c.key+'"]');
          var isBlank = !inp || (inp.value||'').toString().replace(/,/g,'').trim()==='';
          var t = isBlank ? now : parseMoneyInput(inp);
          t = Math.max(0, Math.min(now, t));
          targets[c.key]=t; newSpend+=t;

          var diffEl=$('diff_'+c.key);
          if(diffEl){
            if(isBlank){ diffEl.textContent=''; diffEl.style.color='#111827'; }
            else{
              var diff=t-now; var sign= diff>0?'+':'';
              diffEl.style.color= diff>0 ? '#ef4444' : (diff<0 ? '#10b981' : '#111827');
              diffEl.textContent= sign + thb(diff);
            }
          }
        });

        var incNow=userData.results.inc, debtNow=userData.results.debt;
        var incInp=$('new_income'), debtInp=$('new_debt');

        var incBlank = !incInp || (incInp.value||'').toString().replace(/,/g,'').trim()==='';
        var debtBlank= !debtInp|| (debtInp.value||'').toString().replace(/,/g,'').trim()==='';

        var newInc   = incBlank  ? incNow  : Math.max(0, parseMoneyInput(incInp));
        var newDebt  = debtBlank ? debtNow : Math.max(0, parseMoneyInput(debtInp));

        var di=$('diff_income'); if(di){
          if(incBlank){ di.textContent=''; di.style.color='#111827'; }
          else{ var d=newInc-incNow; di.textContent=(d>0?'+':'')+thb(d); di.style.color=d>=0?'#10b981':'#ef4444'; }
        }
        var dd=$('diff_debt'); if(dd){
          if(debtBlank){ dd.textContent=''; dd.style.color='#111827'; }
          else{ var d2=newDebt-debtNow; dd.textContent=(d2>0?'+':'')+thb(d2); dd.style.color=d2>0?'#ef4444':'#10b981'; }
        }

        var newTotal = newDebt + newSpend;
        var newLiq   = newInc - newTotal;
        var newDTI   = safeDiv(newDebt,newInc)*100;

        var box=$('planSummary'); var stillNeg=newLiq<0;
        box.innerHTML =
          '<div class="grid grid-cols-1 sm:grid-cols-4 gap-2">'+
            '<div><div class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</div><div class="mono font-extrabold">'+thb(newInc)+' ‡∏ø</div></div>'+
            '<div><div class="text-xs text-gray-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î)</div><div class="mono font-extrabold">'+thb(newSpend)+' ‡∏ø</div></div>'+
            '<div><div class="text-xs text-gray-500">DTI ‡πÉ‡∏´‡∏°‡πà</div><div class="mono font-extrabold">'+(isFinite(newDTI)?newDTI.toFixed(1):'‚Äì')+'%</div></div>'+
            '<div><div class="text-xs text-gray-500">‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</div><div class="mono font-extrabold" style="color:'+(stillNeg?'#ef4444':'#10b981')+'">'+thb(newLiq)+' ‡∏ø</div></div>'+
          '</div>'+
          '<div class="mt-2 '+(stillNeg?'text-rose-700':'text-emerald-700')+' text-sm">'+
            (stillNeg?'‡∏¢‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ‚Äù ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢':'‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ')+
          '</div>';

        userData.planTargets=targets;
        userData.planNewIncome=newInc;
        userData.planNewDebt=newDebt;
        userData.planLiq=newLiq;
        debounce();

        efSimRecalc();
      }

      var caps=document.querySelectorAll('[data-cap]'); for(var i=0;i<caps.length;i++){ caps[i].addEventListener('input', recalcPlan); }
      var incInp=$('new_income'), debtInp=$('new_debt');
      if(incInp) incInp.addEventListener('input', recalcPlan);
      if(debtInp) debtInp.addEventListener('input', recalcPlan);
      efSimRecalc();
      recalcPlan();

      $('btnRestart').addEventListener('click', function(){
        userData={ income:0, debtExpense:0, expenses:{}, savings:0 };
        currentStep=0; var fs=$('finalScreen'); if(fs) fs.classList.add('hidden'); var ws=$('welcomeScreen'); if(ws) ws.classList.remove('hidden');
        var pb=$('progressBar'); if(pb) pb.style.width='0%'; persist();
      });

      // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF
      var saveBtn = $('btnSavePdf');
      if(saveBtn){
        saveBtn.addEventListener('click', function(){
          window.scrollTo({ top: 0, behavior: 'instant' });
          setTimeout(function(){ window.print(); }, 60);
        });
      }
    }

    /* ===== Init + robust start/resume ===== */
    function startApp(){ try{ var pc=$('progressContainer'); if(pc) pc.classList.remove('hidden'); start(); }catch(e){ console.error(e); toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô','error'); } }
    function resumeApp(){
      try{
        var hasResults = !!(userData && userData.results);
        if(hasResults){ renderFinal(); }
        else { startApp(); toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß','success'); }
      }catch(e){ console.error(e); startApp(); }
    }

    document.addEventListener('DOMContentLoaded', function(){
      var has=loadState();
      document.body.addEventListener('click', function(e){
        var t=e.target;
        if(t && !t.dataset.action && t.closest){ var b=t.closest('[data-action]'); if(b) t=b; }
        if(t && t.dataset && t.dataset.action==='start'){ e.preventDefault(); startApp(); }
        if(t && t.dataset && t.dataset.action==='resume'){ e.preventDefault(); resumeApp(); }
      });
      var btnResume=$('btnResume');
      if(has && btnResume){ btnResume.classList.remove('hidden'); }
    });
  </script>
</body>
</html>
