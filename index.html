<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‚Ä¢ Simple & Personal (Only-Filled Cuts)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --from:#0f0c29; --mid:#302b63; --to:#24243e;
      --primary:#6366f1; --secondary:#8b5cf6; --success:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; padding:0; box-sizing:border-box;
      font-family:'Inter','Noto Sans Thai',system-ui,-apple-system,'Segoe UI',sans-serif;
      background: linear-gradient(135deg, var(--from) 0%, var(--mid) 50%, var(--to) 100%);
    }
    .glass{ background: rgba(255,255,255,.94); backdrop-filter: blur(16px); border:1px solid rgba(255,255,255,.35) }
    .btn{ position:relative; overflow:hidden; transition:transform .2s ease, box-shadow .2s ease }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(99,102,241,.35) }
    .ring{ transition: stroke-dashoffset .9s cubic-bezier(.2,.8,.2,1) }
    .chip{ display:inline-block; padding:.2rem .5rem; border-radius:.5rem; background:#f1f5f9; font-weight:700; }
    .mono{ font-variant-numeric: tabular-nums; }
    .grid-auto{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem }
    @view-transition { navigation: auto; }
  </style>
</head>
<body class="min-h-full">
  <!-- soft blobs -->
  <div class="pointer-events-none select-none">
    <div class="absolute top-20 left-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply blur-3xl opacity-20"></div>
    <div class="absolute top-40 right-10 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply blur-3xl opacity-20"></div>
    <div class="absolute -bottom-20 left-1/2 w-72 h-72 bg-indigo-500 rounded-full mix-blend-multiply blur-3xl opacity-20"></div>
  </div>

  <main class="relative z-10 min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-3xl">
      <!-- Progress -->
      <div id="progressContainer" class="mb-6 hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-white/80 text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
          <span id="progressText" class="text-white text-sm font-bold">0%</span>
        </div>
        <div class="bg-white/15 rounded-full h-2 overflow-hidden backdrop-blur">
          <div id="progressBar" class="h-2 rounded-full" style="width:0%; background:linear-gradient(90deg,var(--primary),var(--secondary))"></div>
        </div>
      </div>

      <div class="glass rounded-3xl shadow-2xl p-6 sm:p-8">
        <!-- Welcome -->
        <section id="welcomeScreen">
          <div class="text-center">
            <div class="inline-block p-6 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-3xl mb-6 shadow-2xl">
              <div class="text-6xl">üí∞</div>
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-3" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
            <p class="text-gray-500 mb-8 sm:mb-10 text-base sm:text-lg font-medium max-w-md mx-auto">
              ‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ä‡∏±‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            </p>

            <div class="grid gap-3 sm:gap-4">
              <button id="btnStart" class="btn px-6 py-4 sm:px-10 sm:py-5 rounded-2xl text-white font-bold text-base sm:text-lg shadow-xl"
                style="background:linear-gradient(135deg,var(--primary),var(--secondary))">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‚Üí
              </button>
              <button id="btnResume" class="btn px-6 py-4 rounded-2xl font-semibold text-gray-800 bg-white border border-gray-200 hidden">
                ‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
              </button>
            </div>
          </div>
        </section>

        <!-- Questions -->
        <section id="questionScreen" class="hidden">
          <div id="questionContent"></div>
        </section>

        <!-- Attitude -->
        <section id="attitudeScreen" class="hidden">
          <div id="attitudeContent"></div>
        </section>

        <!-- Final -->
        <section id="finalScreen" class="hidden">
          <div id="finalContent"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toastRoot" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-[9999]"></div>

  <script>
    /* ===== Helpers ===== */
    const moneyFmt = new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 });
    const thb = n => moneyFmt.format(Math.round(n||0));
    const buzz = (ms=12)=> (navigator.vibrate && navigator.vibrate(ms));
    function toast(msg, type='info'){
      const root=document.getElementById('toastRoot'); const el=document.createElement('div');
      el.className='px-4 py-3 rounded-xl text-white shadow-lg mb-2';
      el.style.background = type==='success'?'#10b981': type==='warn'?'#f59e0b': type==='error'?'#ef4444':'#6366f1';
      el.textContent=msg; root.appendChild(el);
      setTimeout(()=>{el.style.opacity=.0; el.style.transform='translateY(6px)'},1600);
      setTimeout(()=>el.remove(),2200);
    }

    function parseMoneyInput(el){
      const raw = el.dataset.raw ?? el.value.replace(/,/g,'').trim();
      const n = parseFloat(raw); return isNaN(n)?0:n;
    }
    document.addEventListener('input', (e)=>{
      if(e.target.matches('input[data-money]')){
        const cleaned = e.target.value.replace(/[^\d.]/g,'').replace(/(\..*?)\..*/,'$1');
        e.target.dataset.raw = cleaned;
        if(cleaned===''){ e.target.value=''; return; }
        const parts = cleaned.split('.'); parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        e.target.value = parts.join('.');
      }
    });

    /* ===== Data ===== */
    let currentStep=0, currentAttitudeQuestion=0;
    let userData = { income:0, debtExpense:0, expenses:{}, savings:0, attitudeAnswers:[] };

    const expenseCategories = [
      { key:'food', label:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon:'üçú' },
      { key:'transport', label:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', icon:'üöó' },
      { key:'household', label:'‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', icon:'üè†' },
      { key:'utilities', label:'‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü', icon:'üí°' },
      { key:'entertainment', label:'‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå/‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á', icon:'üéâ' },
      { key:'clothing', label:'‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', icon:'üëî' },
      { key:'internet', label:'‡πÄ‡∏ô‡πá‡∏ï/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', icon:'üì±' },
      { key:'other', label:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon:'üìù' }
    ];

    const attitudeQuestions = [
      { id:'saveFirst',  q:'‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å?', opts:[
        {t:'‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô (Pay Yourself First)', ok:true},
        {t:'‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô', ok:false},
        {t:'‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏≠‡∏°', ok:false}
      ], tipOK:'‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞', tipNG:'‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ß‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å 10‚Äì20% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ‚Äú‡∏≠‡∏≠‡∏°‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á‚Äù' },

      { id:'longPlan',  q:'‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡πÑ‡∏´‡∏°?', opts:[
        {t:'‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠', ok:true},
        {t:'‡∏°‡∏µ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ', ok:false},
        {t:'‡πÑ‡∏°‡πà‡∏°‡∏µ', ok:false}
      ], tipOK:'‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÅ‡∏ú‡∏ô + ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° = ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡πá‡∏ß', tipNG:'‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 1‚Äì3 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },

      { id:'bonusUse',  q:'‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™/‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', opts:[
        {t:'‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å', ok:true},
        {t:'‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ', ok:false},
        {t:'‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏≠‡∏° ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ä‡πâ', ok:false}
      ], tipOK:'‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏±‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô', tipNG:'‡∏Å‡∏±‡∏ô 70‚Äì80% ‡πÄ‡∏Ç‡πâ‡∏≤‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡∏•‡∏á‡∏ó‡∏∏‡∏ô ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏û‡∏≠' },

      { id:'tracking',  q:'‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?', opts:[
        {t:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', ok:true},
        {t:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡πâ‡∏≤‡∏á', ok:false},
        {t:'‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', ok:false}
      ], tipOK:'‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‚Äú‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‚Äù ‡∏Ñ‡∏∑‡∏≠‡∏û‡∏•‡∏±‡∏á', tipNG:'‡∏à‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ/‡∏ä‡∏µ‡∏ï ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },

      { id:'sale',  q:'‡πÄ‡∏à‡∏≠‡πÇ‡∏õ‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', opts:[
        {t:'‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô', ok:true},
        {t:'‡∏£‡∏µ‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°', ok:false},
        {t:'‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô', ok:false}
      ], tipOK:'‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏£‡∏≤‡∏∞ ‚Äú‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á‚Äù', tipNG:'‡∏ñ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á 2 ‡∏Ç‡πâ‡∏≠: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°? ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏´‡∏°?' }
    ];

    const questions = [
      { id:'income',   title:'‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon:'üíµ', desc:'‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‚Äù ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single', field:'income' },
      { id:'debt',     title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon:'üí≥', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô/‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single', field:'debtExpense' },
      { id:'expenses', title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î)', icon:'üõí', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'multiple', field:'expenses' },
      { id:'savings',  title:'‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', icon:'üè¶', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà', type:'single', field:'savings' }
    ];

    /* ===== Autosave / Deep link ===== */
    const SAVE_KEY='finhealth:simple:v1', qs=new URLSearchParams(location.search);
    function loadState(){ try{
      if(qs.get('s')){ userData=JSON.parse(decodeURIComponent(atob(qs.get('s')))); return true; }
      const raw=localStorage.getItem(SAVE_KEY); if(raw){ userData=JSON.parse(raw); return true; }
    }catch(e){} return false;}
    function saveState(){
      const minimal = { income:userData.income, debtExpense:userData.debtExpense, expenses:userData.expenses, savings:userData.savings, attitudeAnswers:userData.attitudeAnswers, results:userData.results||null, sim:userData.sim||null };
      localStorage.setItem(SAVE_KEY, JSON.stringify(minimal));
    }
    const debounce=(fn=>{let t; return ()=>{clearTimeout(t); t=setTimeout(fn,300)}})(saveState);
    function shareResult(){
      if(!userData.results){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','warn'); return; }
      const s=btoa(encodeURIComponent(JSON.stringify(userData)));
      const url=`${location.origin}${location.pathname}?s=${s}`;
      navigator.clipboard?.writeText(url).then(()=>toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß','success'));
    }

    /* ===== Flow ===== */
    const $ = id => document.getElementById(id);
    function setProgress(i, total){ const p=Math.round(i/total*100); $('progressBar').style.width=p+'%'; $('progressText').textContent=p+'%'; }
    function start(){ $('welcomeScreen').classList.add('hidden'); $('progressContainer').classList.remove('hidden'); currentStep=0; renderQuestion(); }
    function prev(){ if(currentStep>0){ currentStep--; renderQuestion(); debounce(); } }
    function inputMoney(id, placeholder='0'){ return `<input type="text" id="${id}" data-money class="w-full px-6 py-4 border-0 rounded-2xl text-xl font-semibold text-gray-800 mono" placeholder="${placeholder}" inputmode="decimal">`; }

    function renderQuestion(){
      const q = questions[currentStep];
      const totalSteps = questions.length + attitudeQuestions.length;
      setProgress(currentStep+1, totalSteps);
      $('questionScreen').classList.remove('hidden');

      if(q.type==='single'){
        $('questionContent').innerHTML = `
          <div class="text-center mb-6">
            <div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4"><div class="text-5xl">${q.icon}</div></div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">${q.title}</h2>
            <p class="text-gray-500 font-medium">${q.desc}</p>
          </div>
          <div class="mb-6">${inputMoney('money_single')}</div>
          <div class="flex gap-3">
            ${currentStep>0?'<button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>':''}
            <button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
          </div>`;
        const el=$('money_single'); const val=userData[q.field]||0; if(val){ el.value=thb(val); el.dataset.raw=val }
      } else {
        const fields = expenseCategories.map(c=>`
          <div>
            <label class="block text-sm font-bold mb-1 text-gray-700 flex items-center gap-2"><span class="text-2xl">${c.icon}</span>${c.label}</label>
            ${inputMoney('ex_'+c.key)}
          </div>`).join('');
        $('questionContent').innerHTML = `
          <div class="text-center mb-5">
            <div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4"><div class="text-5xl">${q.icon}</div></div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">${q.title}</h2>
            <p class="text-gray-500 font-medium">${q.desc}</p>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-5">${fields}</div>
          <div class="flex gap-3">
            <button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
          </div>`;
        expenseCategories.forEach(c=>{ const el=$('ex_'+c.key); const v=userData.expenses[c.key]||0; if(v){ el.value=thb(v); el.dataset.raw=v }});
      }
      const prevBtn=$('btnPrev'); if(prevBtn) prevBtn.onclick=prev;
      $('btnNext').onclick=next;
    }

    function next(){
      const q = questions[currentStep];
      if(q.type==='single'){
        const val=parseMoneyInput($('money_single'));
        if(val<0 || isNaN(val)){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','warn'); return; }
        userData[q.field]=val;
      } else {
        expenseCategories.forEach(c=>{ const el=$('ex_'+c.key); userData.expenses[c.key]=el?parseMoneyInput(el):0; });
      }
      currentStep++; debounce();
      if(currentStep<questions.length){ renderQuestion(); } else { computeCore(); }
      buzz();
    }

    /* ===== Core calculations ===== */
    function computeCore(){
      const inc=userData.income||0, debt=userData.debtExpense||0;
      const spend=Object.values(userData.expenses||{}).reduce((a,b)=>a+(b||0),0);
      const totalExp=debt+spend;
      const sav=userData.savings||0;

      const dti = inc>0 ? (debt/inc)*100 : 0;
      const efMonths = totalExp>0 ? sav/totalExp : 0;
      const liquidity = inc-totalExp;

      // ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
      const dti35 = inc*0.35, dti45=inc*0.45;
      const needTo35 = Math.max(0, debt - dti35);
      const needTo45 = Math.max(0, debt - dti45);
      const needTo3m = Math.max(0, 3*totalExp - sav);
      const needTo6m = Math.max(0, 6*totalExp - sav);

      // Top 3 ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á)
      const offenders = Object.entries(userData.expenses)
                        .map(([k,v])=>({k,v, label:(expenseCategories.find(c=>c.key===k)||{}).label||k}))
                        .filter(x=>x.v>0)
                        .sort((a,b)=>b.v-a.v);

      // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + ‡∏™‡∏µ
      const dtiStatus = dti<=35?'‡∏î‡∏µ‡∏°‡∏≤‡∏Å': dti<=45?'‡∏£‡∏∞‡∏ß‡∏±‡∏á':'‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢';
      const dtiColor  = dti<=35?'#10b981': dti<=45?'#f59e0b':'#ef4444';
      const efStatus  = efMonths<3?'‡πÑ‡∏°‡πà‡∏û‡∏≠': efMonths<=6?'‡∏û‡∏≠':'‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤';
      const efColor   = efMonths<3?'#ef4444': efMonths<=6?'#10b981':'#3b82f6';
      const liqStatus = liquidity<0?'‡∏ï‡∏¥‡∏î‡∏•‡∏ö':'‡∏î‡∏µ';
      const liqColor  = liquidity<0?'#ef4444':'#10b981';

      // ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
      const adviceDTI = (()=> {
        if(dti<=35) return [
          `DTI = ${dti.toFixed(1)}% ‚Üí ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏™‡∏ö‡∏≤‡∏¢`,
          `‡∏Å‡∏±‡∏ô‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (~${thb(inc*0.20)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`,
          `‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏™‡∏π‡∏á ‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏≠‡∏Å‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô`
        ];
        if(dti<=45) return [
          `DTI = ${dti.toFixed(1)}% (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏∂‡∏á)`,
          `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚â§ ${thb(dti35)}‡∏ø (‡∏Ñ‡∏ß‡∏£‡∏•‡∏î ~${thb(needTo35)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`,
          `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡∏£‡∏µ‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå ‡πÅ‡∏•‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß`
        ];
        return [
          `DTI = ${dti.toFixed(1)}% (‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)`,
          `‡∏î‡πà‡∏ß‡∏ô: ‡∏•‡∏î‡∏•‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 45% (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ~${thb(needTo45)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) ‡πÅ‡∏•‡∏∞‡∏°‡∏∏‡πà‡∏á‡πÑ‡∏õ 35% (~${thb(needTo35)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`,
          `‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏£‡∏ß‡∏°‡∏´‡∏ô‡∏µ‡πâ + ‡∏á‡∏î‡∏Å‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà`
        ];
      })();

      const adviceEF = (()=> {
        if(efMonths<3) return [
          `‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ${efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠)`,
          `‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${thb(Math.max(1000, Math.round((needTo3m/6)/100)*100))}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
          `‡∏ñ‡∏∂‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏ï‡πà‡πÑ‡∏õ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏≤‡∏î ~${thb(needTo6m)}‡∏ø)`
        ];
        if(efMonths<=6) return [
          `‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ${efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏û‡∏≠‡πÉ‡∏ä‡πâ)`,
          `‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö 3‚Äì6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏π‡∏á`,
          `‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏¢‡∏Å‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (DCA)`
        ];
        return [
          `‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ${efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤)`,
          `‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ~${thb(Math.max(0, sav-6*totalExp))}‡∏ø ‚Üí ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
          `‡∏Ñ‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÑ‡∏ß‡πâ ~6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πá‡∏û‡∏≠`
        ];
      })();

      const adviceLIQ = (()=> {
        if(liquidity<0){
          const gap=Math.abs(liquidity);
          const cuts = offenders.slice(0,3).map((e,i)=>`${i+1}. ${e.label} ‡∏•‡∏î 15% (~${thb(e.v*0.15)}‡∏ø)`).join(' ‚Ä¢ ');
          return [
            `‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö ~${thb(gap)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
            offenders.length ? `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á): ${cuts}` : `‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô 10‚Äì20% ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß`,
            dti>45 ? `‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏π‡πà: ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô DTI` : `‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ`
          ];
        }
        const to6m = Math.max(0, 6*totalExp - sav);
        const efAlloc = Math.min(liquidity, to6m);
        const investAlloc = Math.max(0, liquidity - efAlloc);
        return [
          `‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ß‡∏Å ~${thb(liquidity)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
          `‡πÅ‡∏ö‡πà‡∏á: ‡πÄ‡∏ï‡∏¥‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ~${thb(efAlloc)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
          `‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~${thb(investAlloc)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠`
        ];
      })();

      userData.results = { inc, debt, spend, totalExp, sav, dti, efMonths, liquidity, 
        dtiStatus, dtiColor, efStatus, efColor, liqStatus, liqColor, 
        needTo35, needTo45, needTo3m, needTo6m, offenders,
        advice:{ dti:adviceDTI, ef:adviceEF, liq:adviceLIQ }
      };
      debounce();
      renderAttitude();
    }

    /* ===== Attitude ===== */
    function renderAttitude(){
      $('questionScreen').classList.add('hidden');
      $('attitudeScreen').classList.remove('hidden');
      currentAttitudeQuestion=0; userData.attitudeAnswers=[];
      showAttitudeQ();
    }
    function setProgressAtt(){ setProgress(questions.length + currentAttitudeQuestion + 1, questions.length + attitudeQuestions.length); }
    function showAttitudeQ(){
      const q = attitudeQuestions[currentAttitudeQuestion]; setProgressAtt();
      const opts = q.opts.map((o,i)=>`<button class="btn w-full text-left px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl border-2 border-gray-200 hover:border-indigo-400 font-semibold text-gray-800 shadow-sm" data-ans="${i}">
        <span class="flex items-center gap-3"><span class="text-2xl">‚Ä¢</span><span>${o.t}</span></span></button>`).join('');
      $('attitudeContent').innerHTML = `
        <div class="text-center mb-6">
          <div class="inline-block p-5 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl mb-4"><div class="text-5xl">ü§î</div></div>
          <div class="inline-block px-3 py-1 bg-purple-100 rounded-full mb-3 text-purple-700 text-sm font-bold">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttitudeQuestion+1}/${attitudeQuestions.length}</div>
          <p class="text-xl text-gray-800 font-bold leading-relaxed max-w-lg mx-auto">${q.q}</p>
        </div>
        <div class="grid gap-3">${opts}</div>`;
      $('attitudeContent').querySelectorAll('[data-ans]').forEach(b=> b.onclick=()=>selectAtt(parseInt(b.dataset.ans,10)));
    }
    function selectAtt(i){
      const q=attitudeQuestions[currentAttitudeQuestion], sel=q.opts[i];
      userData.attitudeAnswers.push({ id:q.id, q:q.q, a:sel.t, ok:sel.ok, tip: sel.ok ? q.tipOK : q.tipNG });
      currentAttitudeQuestion++;
      if(currentAttitudeQuestion<attitudeQuestions.length) { showAttitudeQ(); }
      else { renderFinal(); }
      buzz();
    }

    /* ===== Final + Rings + What-if ===== */
    function ring(el, pct, color, label, valueText){
      const R=54, C=2*Math.PI*R, p=Math.max(0,Math.min(100,pct));
      el.innerHTML = `
        <div class="p-4 rounded-2xl bg-white/90 border border-white/60 shadow text-center">
          <svg width="140" height="140" viewBox="0 0 140 140" class="mx-auto block">
            <circle cx="70" cy="70" r="${R}" stroke="#e5e7eb" stroke-width="14" fill="none"/>
            <circle cx="70" cy="70" r="${R}" stroke="${color}" stroke-linecap="round" stroke-width="14" fill="none"
              class="ring" style="stroke-dasharray:${C};stroke-dashoffset:${C};transform:rotate(-90deg);transform-origin:50% 50%"/>
            <text x="50%" y="50%" text-anchor="middle" dy="8" font-size="22" font-weight="800" fill="${color}">${valueText}</text>
          </svg>
          <div class="mt-2 font-bold text-gray-800">${label}</div>
        </div>`;
      requestAnimationFrame(()=>{ el.querySelectorAll('circle')[1].style.strokeDashoffset = C*(1 - p/100); });
    }

    function bList(lines){ return `<ul class="list-disc list-inside text-gray-700 leading-relaxed">${lines.map(x=>`<li>${x}</li>`).join('')}</ul>`; }

    // ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏î‡∏≤‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏à‡∏∞ ‚Äú‡∏ä‡∏µ‡πâ‡πÅ‡∏ô‡∏∞/‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á
    function capTable(caps, data){
      const rows = expenseCategories.map(c=>{
        const cap=caps[c.key]||0, now=data.expenses[c.key]||0;
        const diff = now>0 ? (cap-now) : 0; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å (now=0) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
        const color = now>0 ? (diff>=0?'#10b981':'#ef4444') : '#94a3b8'; // grey ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å
        const diffText = now>0 ? ( (diff>=0?'+':'') + thb(diff) ) : '‚Äî'; // ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‚áí ‡πÅ‡∏™‡∏î‡∏á ‚Äî
        const dim = now>0 ? '' : 'opacity-60';
        return `<tr class="text-sm ${dim}">
          <td class="py-2">${c.icon} ${c.label}</td>
          <td class="py-2 text-right mono">${thb(now)}</td>
          <td class="py-2 text-right mono">${thb(cap)}</td>
          <td class="py-2 text-right mono" style="color:${color}">${diffText}</td>
        </tr>`;
      }).join('');
      return `<table class="w-full"><thead>
        <tr class="text-xs text-gray-500 border-b"><th class="py-2 text-left">‡∏´‡∏°‡∏ß‡∏î</th><th class="py-2 text-right">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</th><th class="py-2 text-right">‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th><th class="py-2 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th></tr>
      </thead><tbody>${rows}</tbody></table>
      <div class="text-xs text-gray-500 mt-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>`;
    }

    function attitudeAdviceHTML(){
      const items = userData.attitudeAnswers.map((a,idx)=>`
        <div class="rounded-xl border p-3 bg-white">
          <div class="flex items-center justify-between mb-1">
            <div class="font-semibold">‡∏Ç‡πâ‡∏≠ ${idx+1}</div>
            <span class="text-xs px-2 py-0.5 rounded-full text-white" style="background:${a.ok?'#10b981':'#f59e0b'}">${a.ok?'‡∏î‡∏µ':'‡∏õ‡∏£‡∏±‡∏ö‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á'}</span>
          </div>
          <div class="text-sm text-gray-800 mb-1">‚Ä¢ ${a.q}</div>
          <div class="text-sm ${a.ok?'text-green-700':'text-amber-700'}">‚Üí ${a.tip}</div>
        </div>
      `).join('');
      return `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${items}</div>`;
    }

    function renderFinal(){
      $('attitudeScreen').classList.add('hidden');
      $('progressContainer').classList.add('hidden');
      $('finalScreen').classList.remove('hidden');

      const R=userData.results;
      const correct=userData.attitudeAnswers.filter(a=>a.ok).length;

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
      const base = { food:.15, transport:.10, household:.06, utilities:.07, entertainment:.05, clothing:.03, internet:.03, other:.06 };
      const baseSum = Object.values(base).reduce((a,b)=>a+b,0);
      const scale = Math.min(.65, Math.max(.45, (R.spend/R.inc) || .55));
      const caps={}; Object.entries(base).forEach(([k,v])=> caps[k]=Math.round(R.inc*(v/baseSum)*scale));

      // ‚úÖ ‚Äú‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞ ‚Äú‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏î‡∏≤‡∏ô‚Äù
      const overCaps = expenseCategories.map(c=>{
        const now=userData.expenses[c.key]||0, cap=caps[c.key]||0;
        const over = Math.max(0, now-cap);
        return { key:c.key, label:c.label, now, cap, over };
      }).filter(x=> x.now>0 && x.over>0)
        .sort((a,b)=> b.over - a.over);

      // ring UI
      const dtiPct = Math.max(0, 100 - Math.min(100, R.dti));
      const efPct  = Math.min(100, (R.efMonths/6)*100);
      const liqPct = R.liquidity<=0 ? 0 : Math.min(100, (R.liquidity / (R.inc||1))*100);

      $('finalContent').innerHTML = `
        <div class="text-center mb-2">
          <div class="inline-block p-5 bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl mb-3"><div class="text-5xl">‚ú®</div></div>
          <h2 class="text-2xl sm:text-3xl font-extrabold" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">
            ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å)
          </h2>
          <p class="text-gray-500">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <div id="ringRow" class="grid grid-cols-1 sm:grid-cols-3 gap-3 my-4"></div>

        <div class="grid gap-4">
          <!-- DTI -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow" style="border-color:${R.dtiColor}">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ (DTI)</h3>
              <span class="px-3 py-1 text-xs rounded-full text-white" style="background:${R.dtiColor}">${R.dtiStatus}</span>
            </div>
            <div class="text-3xl font-extrabold mb-1" style="color:${R.dtiColor}">${R.dti.toFixed(1)}%</div>
            ${bList(R.advice.dti)}
          </div>

          <!-- EF -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow" style="border-color:${R.efColor}">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h3>
              <span class="px-3 py-1 text-xs rounded-full text-white" style="background:${R.efColor}">${R.efStatus}</span>
            </div>
            <div class="text-3xl font-extrabold mb-1" style="color:${R.efColor}">${R.efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            ${bList(R.advice.ef)}
          </div>

          <!-- LIQ -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow" style="border-color:${R.liqColor}">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
              <span class="px-3 py-1 text-xs rounded-full text-white" style="background:${R.liqColor}">${R.liqStatus}</span>
            </div>
            <div class="text-3xl font-extrabold mb-1" style="color:${R.liqColor}">${thb(R.liquidity)} ‡∏ø</div>
            ${bList(R.advice.liq)}
          </div>

          <!-- Start Today (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏ß‡πà‡∏≤ ‚Äú‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‚Äù) -->
          <div class="bg-white rounded-2xl p-5 border">
            <div class="flex items-center gap-2 mb-2"><span class="text-2xl">üèÅ</span><h3 class="text-lg font-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (3 ‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡πâ‡∏ô‡πÜ)</h3></div>
            ${bList([
              (R.efMonths<3?`‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${thb(Math.max(1000,Math.round((R.needTo3m/6)/100)*100))}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äú‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‚Äù`:`‡∏Ñ‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ‚â•3‚Äì6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏•‡∏á‡∏ó‡∏∏‡∏ô`),
              (R.dti>45?`‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚Äú‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏£‡∏µ‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå‚Äù ‡∏•‡∏î‡∏à‡πà‡∏≤‡∏¢/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ~${thb(R.needTo45)}‡∏ø`:
               R.dti>35?`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏∞ DTI ‚â§35% (‡∏•‡∏î ~${thb(R.needTo35)}‡∏ø)`:`‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡∏° 20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`),
              (R.offenders.length>0?`‡∏ï‡∏±‡∏î Top3 ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞ ~15% (‡∏•‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏ß ${thb(R.offenders.slice(0,3).reduce((s,x)=>s+x.v*0.15,0))}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`:`‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô`)
            ])}
          </div>

          <!-- Attitude Advice -->
          <div class="bg-white rounded-2xl p-5 border">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-2xl">üéØ</span>
              <h3 class="text-lg font-bold">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡∏®‡∏ô‡∏Ñ‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
            </div>
            <div class="text-sm text-gray-600 mb-3">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å ${correct}/${attitudeQuestions.length} ‡∏Ç‡πâ‡∏≠</div>
            ${attitudeAdviceHTML()}
          </div>

          <!-- ‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î -->
          <div class="bg-white rounded-2xl p-5 border">
            <div class="flex items-center gap-2 mb-2"><span class="text-2xl">üì¶</span><h3 class="text-lg font-bold">‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì)</h3></div>
            ${capTable(caps, userData)}
          </div>

          <!-- ‚úÖ ‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å + ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏î‡∏≤‡∏ô) -->
          <div class="bg-white rounded-2xl p-5 border">
            <div class="flex items-center gap-2 mb-2"><span class="text-2xl">‚úÇÔ∏è</span><h3 class="text-lg font-bold">‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏•‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å)</h3></div>
            ${
              overCaps.length
              ? bList(overCaps.slice(0,6).map(x=>`‡∏•‡∏î ‚Äú${x.label}‚Äù ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${thb(x.over)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏î‡∏≤‡∏ô (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ${thb(x.now)}‡∏ø | ‡πÄ‡∏û‡∏î‡∏≤‡∏ô ${thb(x.cap)}‡∏ø)`))
              : '<div class="text-sm text-gray-600">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏´‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å</div>'
            }
          </div>
        </div>

        <!-- What-if (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô Top3 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) -->
        <div class="bg-white/90 border rounded-2xl p-5 shadow mt-4">
          <div class="flex items-center gap-2 mb-2"><span class="text-2xl">üß™</span><h3 class="text-lg font-bold">‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</h3></div>
          <div class="grid-auto">
            <div>
              <label class="block text-sm font-semibold mb-1">‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ Top 3 (‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å)</label>
              <input id="simCut" type="range" min="0" max="40" step="1" value="15" class="w-full">
              <div class="text-xs text-gray-600">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span id="simCutVal" class="mono">15%</span></div>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡πÇ‡∏õ‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <input id="simDebt" type="range" min="0" max="50" step="1" value="10" class="w-full">
              <div class="text-xs text-gray-600">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span id="simDebtVal" class="mono">10%</span> ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (<span id="simDebtBaht" class="mono"></span>‡∏ø)</div>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <input id="simEF" type="range" min="0" max="30" step="1" value="10" class="w-full">
              <div class="text-xs text-gray-600">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <span id="simEFVal" class="mono">10%</span> ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (<span id="simEFBaht" class="mono"></span>‡∏ø)</div>
            </div>
          </div>

          <div id="simResult" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4"></div>
          <div id="simAdvice" class="text-sm text-gray-700 leading-relaxed mt-3"></div>
        </div>

        <!-- Actions -->
        <div class="grid gap-3 sm:grid-cols-2 mt-5">
          <button id="btnRestart" class="btn px-6 py-4 rounded-2xl text-white font-bold" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
          <button id="btnShare" class="btn px-6 py-4 rounded-2xl font-semibold bg-white border">üîó ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
        </div>
      `;

      // ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô
      const row=$('ringRow'); const a=document.createElement('div'), b=document.createElement('div'), c=document.createElement('div'); row.append(a,b,c);
      ring(a, dtiPct, R.dtiColor, 'DTI (‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)', `${dtiPct.toFixed(0)}%`);
      ring(b, efPct,  R.efColor, '‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', `${R.efMonths.toFixed(1)}‡∏î.`);
      ring(c, liqPct, R.liqColor, '‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á/‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', `${liqPct.toFixed(0)}%`);

      // What-if
      const simCut=$('simCut'), simDebt=$('simDebt'), simEF=$('simEF');
      const simCutVal=$('simCutVal'), simDebtVal=$('simDebtVal'), simEFVal=$('simEFVal');
      const simDebtBaht=$('simDebtBaht'), simEFBaht=$('simEFBaht');
      function syncLabels(){
        simCutVal.textContent = simCut.value+'%';
        simDebtVal.textContent = simDebt.value+'%';
        simEFVal.textContent = simEF.value+'%';
        simDebtBaht.textContent = thb(R.inc * (simDebt.value/100));
        simEFBaht.textContent = thb(R.inc * (simEF.value/100));
      }
      function runSim(){
        const cutPct = Number(simCut.value)/100;
        const addDebt = R.inc * (Number(simDebt.value)/100);
        const saveEF  = R.inc * (Number(simEF.value)/100);

        let spendNew = R.spend;
        const top3 = [...R.offenders].slice(0,3); // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á
        top3.forEach(t=> spendNew -= t.v * cutPct);
        spendNew = Math.max(0, spendNew);

        const debtNew = Math.max(0, R.debt - addDebt);
        const totalNew = spendNew + debtNew;
        const dtiNew = R.inc>0 ? (debtNew/R.inc)*100 : 0;
        const liqNew = R.inc - totalNew - saveEF;
        const efMonthsNew = (R.sav + saveEF) / (totalNew>0? totalNew:1);

        const card = (label,val,sub,color)=>`
          <div class="rounded-xl border p-4 text-center" style="border-color:${color}">
            <div class="text-xs text-gray-500 mb-1">${label}</div>
            <div class="text-2xl font-extrabold mono" style="color:${color}">${val}</div>
            <div class="text-xs text-gray-500 mt-1">${sub}</div>
          </div>`;
        $('simResult').innerHTML = [
          card('DTI ‡πÉ‡∏´‡∏°‡πà', dtiNew.toFixed(1)+'%', `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á: ${(R.dti - dtiNew).toFixed(1)} ‡∏à‡∏∏‡∏î`, '#6366f1'),
          card('‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', efMonthsNew.toFixed(1)+' ‡∏î.', `‡∏≠‡∏≠‡∏°/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${thb(saveEF)}‡∏ø`, '#10b981'),
          card('‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', `${thb(liqNew)}‡∏ø`, `‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏±‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ${thb(saveEF)}‡∏ø`, liqNew>=0?'#10b981':'#ef4444')
        ].join('');

        const needTo35New = Math.max(0, debtNew - (R.inc*0.35));
        const monthsTo3m = R.needTo3m>0 && saveEF>0 ? Math.ceil(R.needTo3m / saveEF) : 0;
        $('simAdvice').innerHTML = `
          <div class="grid-auto mt-1">
            <div class="bg-white rounded-lg p-3 border"><div class="font-semibold mb-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ DTI 35%</div>
              ${needTo35New<=0 ? '<div class="text-sm text-green-700">‚úÖ ‡πÅ‡∏ï‡∏∞ ‚â§35% ‡πÅ‡∏•‡πâ‡∏ß</div>' :
               `<div class="text-sm">‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ/‡∏£‡∏µ‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå‡∏≠‡∏µ‡∏Å <span class="chip mono">${thb(needTo35New)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div>`}
            </div>
            <div class="bg-white rounded-lg p-3 border"><div class="font-semibold mb-1">‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
              ${R.needTo3m<=0 ? '<div class="text-sm text-green-700">‚úÖ ‡∏Ñ‡∏£‡∏ö ‚â•3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>' :
               saveEF<=0 ? '<div class="text-sm text-amber-700">‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>' :
               `<div class="text-sm">‡∏Ñ‡∏≤‡∏î ~<span class="chip mono">${monthsTo3m} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‡∏´‡∏≤‡∏Å‡∏≠‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ <span class="chip mono">${thb(saveEF)}‡∏ø</span></div>`}
            </div>
            <div class="bg-white rounded-lg p-3 border"><div class="font-semibold mb-1">‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
              <div class="text-sm">‡∏ï‡∏±‡∏î Top3 (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å) ~<span class="chip mono">${simCut.value}%</span> 
              ‚Üí ‡∏•‡∏î‡∏£‡∏ß‡∏° ~<span class="chip mono">${thb(top3.reduce((s,x)=>s+x.v*(cutPct),0))}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div>
            </div>
          </div>`;
        userData.sim = { cutPct, addDebt, saveEF, dtiNew, efMonthsNew, liqNew };
        debounce();
      }
      syncLabels(); runSim();
      [simCut,simDebt,simEF].forEach(el=> el.addEventListener('input', ()=>{ syncLabels(); runSim(); }));

      $('btnRestart').onclick = ()=>{
        userData = { income:0, debtExpense:0, expenses:{}, savings:0, attitudeAnswers:[] };
        currentStep=0; $('finalScreen').classList.add('hidden'); $('welcomeScreen').classList.remove('hidden'); $('progressBar').style.width='0%'; saveState();
      };
      $('btnShare').onclick = shareResult;
    }

    /* ===== Init ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      const has = loadState();
      const btnStart=document.getElementById('btnStart');
      const btnResume=document.getElementById('btnResume');
      btnStart.onclick = ()=>{ $('progressContainer').classList.remove('hidden'); start(); };
      if(has){ btnResume.classList.remove('hidden'); btnResume.onclick = ()=>{ if(userData.results){ renderFinal(); } else { $('progressContainer').classList.remove('hidden'); start(); } toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß','success'); } }
    });
  </script>
</body>
</html>
