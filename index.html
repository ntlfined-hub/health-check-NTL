<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‚Ä¢ Hyper-Personal Advice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --from:#0f0c29; --mid:#302b63; --to:#24243e;
      --primary:#6366f1; --secondary:#8b5cf6; --success:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; padding:0; box-sizing:border-box;
      font-family:'Inter','Noto Sans Thai',system-ui,-apple-system,'Segoe UI',sans-serif;
      background: linear-gradient(135deg, var(--from) 0%, var(--mid) 50%, var(--to) 100%);
    }
    .glass{ background: rgba(255,255,255,.94); backdrop-filter: blur(16px); border:1px solid rgba(255,255,255,.35) }
    .btn{ position:relative; overflow:hidden; transition:transform .2s ease, box-shadow .2s ease }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(99,102,241,.35) }
    .ring{ transition: stroke-dashoffset .9s cubic-bezier(.2,.8,.2,1) }
    .chip{ display:inline-block; padding:.25rem .55rem; border-radius:.5rem; background:#f1f5f9; font-weight:700; }
    .mono{ font-variant-numeric: tabular-nums; }
    .grid-auto{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:.75rem }
    @view-transition { navigation: auto; }
  </style>
</head>
<body class="min-h-full">
  <!-- blobs -->
  <div class="pointer-events-none select-none">
    <div class="absolute top-20 left-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply blur-3xl opacity-20"></div>
    <div class="absolute top-40 right-10 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply blur-3xl opacity-20" style="animation-delay:1s"></div>
    <div class="absolute -bottom-20 left-1/2 w-72 h-72 bg-indigo-500 rounded-full mix-blend-multiply blur-3xl opacity-20" style="animation-delay:2s"></div>
  </div>

  <main class="relative z-10 min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-3xl">
      <!-- Progress -->
      <div id="progressContainer" class="mb-6 hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-white/80 text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
          <span id="progressText" class="text-white text-sm font-bold">0%</span>
        </div>
        <div class="bg-white/15 rounded-full h-2 overflow-hidden backdrop-blur">
          <div id="progressBar" class="h-2 rounded-full" style="width:0%; background:linear-gradient(90deg,var(--primary),var(--secondary))"></div>
        </div>
      </div>

      <div class="glass rounded-3xl shadow-2xl p-6 sm:p-8">
        <!-- Welcome -->
        <section id="welcomeScreen">
          <div class="text-center">
            <div class="inline-block p-6 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-3xl mb-6 shadow-2xl">
              <div class="text-6xl">üí∞</div>
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold mb-3" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
            <p class="text-gray-500 mb-8 sm:mb-10 text-base sm:text-lg font-medium max-w-md mx-auto">
              ‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö ‚Äú‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì‚Äù ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            </p>

            <div class="grid gap-3 sm:gap-4">
              <button id="btnStart" class="btn px-6 py-4 sm:px-10 sm:py-5 rounded-2xl text-white font-bold text-base sm:text-lg shadow-xl"
                style="background:linear-gradient(135deg,var(--primary),var(--secondary))">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‚Üí
              </button>
              <button id="btnResume" class="btn px-6 py-4 rounded-2xl font-semibold text-gray-800 bg-white border border-gray-200 hidden">
                ‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
              </button>
            </div>
          </div>
        </section>

        <!-- Questions -->
        <section id="questionScreen" class="hidden">
          <div id="questionContent"></div>
        </section>

        <!-- Attitude -->
        <section id="attitudeScreen" class="hidden">
          <div id="attitudeContent"></div>
        </section>

        <!-- Final -->
        <section id="finalScreen" class="hidden">
          <div id="finalContent"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div id="toastRoot" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-[9999]"></div>

  <script>
    /* ===== Helpers ===== */
    const moneyFmt = new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 });
    const pctFmt = n => `${(n*100).toFixed(0)}%`;
    const thb = n => moneyFmt.format(Math.round(n||0));
    const buzz = (ms=12)=> (navigator.vibrate && navigator.vibrate(ms));
    function toast(msg, type='info'){
      const root=document.getElementById('toastRoot'); const el=document.createElement('div');
      el.className='px-4 py-3 rounded-xl text-white shadow-lg mb-2';
      el.style.background = type==='success'?'#10b981':type==='warn'?'#f59e0b':type==='error'?'#ef4444':'#6366f1';
      el.textContent=msg; root.appendChild(el);
      setTimeout(()=>{el.style.opacity=.0; el.style.transform='translateY(6px)'},1600);
      setTimeout(()=>el.remove(),2200);
    }

    // Money input formatting (live)
    function parseMoneyInput(el){
      const raw = el.dataset.raw ?? el.value.replace(/,/g,'').trim();
      const n = parseFloat(raw); return isNaN(n)?0:n;
    }
    document.addEventListener('input', (e)=>{
      if(e.target.matches('input[data-money]')){
        const cleaned = e.target.value.replace(/[^\d.]/g,'').replace(/(\..*?)\..*/,'$1');
        e.target.dataset.raw = cleaned;
        if(cleaned===''){ e.target.value=''; return; }
        const parts = cleaned.split('.'); parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        e.target.value = parts.join('.');
      }
    });

    /* ===== Data ===== */
    let currentStep=0, currentAttitudeQuestion=0;
    let userData = { income:0, debtExpense:0, expenses:{}, savings:0, attitudeAnswers:[] };

    const expenseCategories = [
      { key:'food', label:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon:'üçú' },
      { key:'transport', label:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', icon:'üöó' },
      { key:'household', label:'‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', icon:'üè†' },
      { key:'utilities', label:'‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü', icon:'üí°' },
      { key:'entertainment', label:'‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå/‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á', icon:'üéâ' },
      { key:'clothing', label:'‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', icon:'üëî' },
      { key:'internet', label:'‡πÄ‡∏ô‡πá‡∏ï/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', icon:'üì±' },
      { key:'other', label:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon:'üìù' }
    ];

    const attitudeQuestions = [
      { q:'‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å?', opts:[
        {t:'‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô (Pay Yourself First)', ok:true},
        {t:'‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô', ok:false},
        {t:'‡πÉ‡∏ä‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏≠‡∏°', ok:false}
      ], ex:'‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏•‡πá‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≠‡∏°‡∏à‡∏£‡∏¥‡∏á' },
      { q:'‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡πÑ‡∏´‡∏°?', opts:[
        {t:'‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠', ok:true},
        {t:'‡∏°‡∏µ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ', ok:false},{t:'‡πÑ‡∏°‡πà‡∏°‡∏µ', ok:false}
      ], ex:'‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° = ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏á‡πà‡∏≤‡∏¢' },
      { q:'‡πÑ‡∏î‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', opts:[
        {t:'‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å', ok:true},
        {t:'‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ', ok:false},
        {t:'‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏≠‡∏° ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ä‡πâ', ok:false}
      ], ex:'‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á' },
      { q:'‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô?', opts:[
        {t:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', ok:true},
        {t:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡πâ‡∏≤‡∏á', ok:false},{t:'‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', ok:false}
      ], ex:'‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°' },
      { q:'‡πÄ‡∏´‡πá‡∏ô‡πÇ‡∏õ‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à?', opts:[
        {t:'‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô', ok:true},
        {t:'‡∏£‡∏µ‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°', ok:false},
        {t:'‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô', ok:false}
      ], ex:'‡∏ñ‡∏π‡∏Å‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÅ‡∏û‡∏á' }
    ];

    const questions = [
      { id:'income',   title:'‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon:'üíµ', desc:'‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‚Äù ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single', field:'income' },
      { id:'debt',     title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', icon:'üí≥', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô/‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single', field:'debtExpense' },
      { id:'expenses', title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î)', icon:'üõí', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'multiple', field:'expenses' },
      { id:'savings',  title:'‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', icon:'üè¶', desc:'‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà', type:'single', field:'savings' }
    ];

    /* ===== Autosave / Deep link ===== */
    const SAVE_KEY='finhealth:hyper:v1', qs=new URLSearchParams(location.search);
    function loadState(){ try{
      if(qs.get('s')){ userData=JSON.parse(decodeURIComponent(atob(qs.get('s')))); return true; }
      const raw=localStorage.getItem(SAVE_KEY); if(raw){ userData=JSON.parse(raw); return true; }
    }catch(e){} return false;}
    function saveState(){
      const minimal = { income:userData.income, debtExpense:userData.debtExpense, expenses:userData.expenses, savings:userData.savings, attitudeAnswers:userData.attitudeAnswers, results:userData.results||null, sim:userData.sim||null };
      localStorage.setItem(SAVE_KEY, JSON.stringify(minimal));
    }
    const debounce=(fn=>{let t; return ()=>{clearTimeout(t); t=setTimeout(fn,320)}})(saveState);
    function shareResult(){
      if(!userData.results){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','warn'); return; }
      const s=btoa(encodeURIComponent(JSON.stringify(userData)));
      const url=`${location.origin}${location.pathname}?s=${s}`;
      navigator.clipboard?.writeText(url).then(()=>toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß','success'));
    }

    /* ===== Flow ===== */
    const $ = id => document.getElementById(id);
    function setProgress(i, total){ const p=Math.round(i/total*100); $('progressBar').style.width=p+'%'; $('progressText').textContent=p+'%'; }
    function start(){ $('welcomeScreen').classList.add('hidden'); $('progressContainer').classList.remove('hidden'); currentStep=0; renderQuestion(); }
    function prev(){ if(currentStep>0){ currentStep--; renderQuestion(); debounce(); } }
    function inputMoney(id, placeholder='0'){ return `<input type="text" id="${id}" data-money class="w-full px-6 py-4 border-0 rounded-2xl text-xl font-semibold text-gray-800 mono" placeholder="${placeholder}" inputmode="decimal">`; }

    function renderQuestion(){
      const q = questions[currentStep];
      const totalSteps = questions.length + attitudeQuestions.length;
      setProgress(currentStep+1, totalSteps);
      $('questionScreen').classList.remove('hidden');

      if(q.type==='single'){
        $('questionContent').innerHTML = `
          <div class="text-center mb-6">
            <div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4"><div class="text-5xl">${q.icon}</div></div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">${q.title}</h2>
            <p class="text-gray-500 font-medium">${q.desc}</p>
          </div>
          <div class="mb-6">${inputMoney('money_single')}</div>
          <div class="flex gap-3">
            ${currentStep>0?'<button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>':''}
            <button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
          </div>`;
        const el=$('money_single'); const val=userData[q.field]||0; if(val){ el.value=thb(val); el.dataset.raw=val }
      } else {
        const fields = expenseCategories.map(c=>`
          <div>
            <label class="block text-sm font-bold mb-1 text-gray-700 flex items-center gap-2"><span class="text-2xl">${c.icon}</span>${c.label}</label>
            ${inputMoney('ex_'+c.key)}
          </div>`).join('');
        $('questionContent').innerHTML = `
          <div class="text-center mb-5">
            <div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4"><div class="text-5xl">${q.icon}</div></div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">${q.title}</h2>
            <p class="text-gray-500 font-medium">${q.desc}</p>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-5">${fields}</div>
          <div class="flex gap-3">
            <button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
          </div>`;
        expenseCategories.forEach(c=>{ const el=$('ex_'+c.key); const v=userData.expenses[c.key]||0; if(v){ el.value=thb(v); el.dataset.raw=v }});
      }
      const prevBtn=$('btnPrev'); if(prevBtn) prevBtn.onclick=prev;
      $('btnNext').onclick=next;
    }

    function next(){
      const q = questions[currentStep];
      if(q.type==='single'){
        const val=parseMoneyInput($('money_single'));
        if(val<0 || isNaN(val)){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','warn'); return; }
        userData[q.field]=val;
      } else {
        expenseCategories.forEach(c=>{ const el=$('ex_'+c.key); userData.expenses[c.key]=el?parseMoneyInput(el):0; });
      }
      currentStep++; debounce();
      if(currentStep<questions.length){ renderQuestion(); } else { computeCore(); }
      buzz();
    }

    /* ===== Core calculations & personalized advice model ===== */
    function computeCore(){
      const inc=userData.income||0, debt=userData.debtExpense||0;
      const spend=Object.values(userData.expenses||{}).reduce((a,b)=>a+(b||0),0);
      const totalExp=debt+spend;
      const sav=userData.savings||0;

      const dti = inc>0 ? (debt/inc)*100 : 0;
      const efMonths = totalExp>0 ? sav/totalExp : 0;
      const liquidity = inc-totalExp;

      // Target caps per-category (personalized budget rails)
      // rule: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß scale ‡∏ï‡∏≤‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏£‡∏¥‡∏á: base caps + dynamic nudge
      const base = { food:.15, transport:.10, household:.06, utilities:.07, entertainment:.05, clothing:.03, internet:.03, other:.06 }; // 55% ‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
      const baseSum = Object.values(base).reduce((a,b)=>a+b,0);
      const scale = Math.min(.65, Math.max(.45, spend/inc || .55)); // ‡∏™‡∏≤‡∏¢‡πÄ‡∏õ‡∏¢‡πå=‡∏™‡∏π‡∏á, ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î=‡∏ï‡πà‡∏≥
      const caps = {}; Object.entries(base).forEach(([k,v])=> caps[k] = Math.round(inc * (v/baseSum) * scale));

      // DTI targets
      const dti35 = inc*0.35, dti45=inc*0.45;
      const needTo35 = Math.max(0, debt - dti35);
      const needTo45 = Math.max(0, debt - dti45);

      // EF targets
      const needTo3m = Math.max(0, 3*totalExp - sav);
      const needTo6m = Math.max(0, 6*totalExp - sav);

      // Top offenders
      const offenders = Object.entries(userData.expenses).map(([k,v])=>({k,v, label:(expenseCategories.find(c=>c.key===k)||{}).label||k}))
                        .sort((a,b)=>b.v-a.v).filter(x=>x.v>0);

      // Build detailed prescriptions
      function buildCuts(required){
        // ‡∏ï‡∏±‡∏î‡∏à‡∏≤‡∏Å top offenders ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö: 15% / 10% / 5% ‡∏à‡∏ô‡∏û‡∏≠
        let remain=required, plan=[], levels=[.15,.10,.08,.05];
        for(const off of offenders){
          for(const lv of levels){
            if(remain<=0) break;
            const canCut = Math.min(off.v*lv, remain);
            if(canCut>0){
              plan.push({label:off.label, pct:lv, amount:Math.round(canCut/100)*100});
              remain -= canCut;
            }
          }
          if(remain<=0) break;
        }
        if(remain>0 && required>0) plan.push({label:'‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏£‡∏ß‡∏°', pct:0.05, amount:Math.round(remain/100)*100});
        return plan;
      }

      // ‡∏ñ‡πâ‡∏≤ DTI>35 ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏£‡∏µ‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå
      const dtiStatus = dti<=35?'‡∏î‡∏µ‡∏°‡∏≤‡∏Å': dti<=45?'‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á':'‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢';
      const dtiColor = dti<=35?'#10b981': dti<=45?'#f59e0b':'#ef4444';

      // EF status
      const efStatus = efMonths<3?'‡πÑ‡∏°‡πà‡∏û‡∏≠': efMonths<=6?'‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠':'‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤';
      const efColor = efMonths<3?'#ef4444': efMonths<=6?'#10b981':'#3b82f6';

      // Liquidity status
      const liqStatus = liquidity<0?'‡∏ï‡∏¥‡∏î‡∏•‡∏ö':'‡∏î‡∏µ';
      const liqColor = liquidity<0?'#ef4444':'#10b981';

      // Personalized actions
      const actions = {
        dti: (()=>{
          const lines = [];
          if(dti<=35){
            lines.push(`DTI = ${dti.toFixed(1)}% ‚Üí ‡∏î‡∏µ‡∏°‡∏≤‡∏Å`);
            lines.push(`‡∏•‡πá‡∏≠‡∏Å ‚Äú‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‚Äù ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‚âà <span class="chip mono">${thb(inc*0.20)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>`);
          }else if(dti<=45){
            lines.push(`DTI = ${dti.toFixed(1)}% (‡∏£‡∏∞‡∏ß‡∏±‡∏á) ‚Üí ‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <span class="chip mono">${thb(needTo35)}‡∏ø</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞ 35%`);
            lines.push(`‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î/‡∏£‡∏µ‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πà‡∏≥`);
          }else{
            lines.push(`DTI = ${dti.toFixed(1)}% (‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)`);
            lines.push(`‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô: ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 45% (‡∏•‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <span class="chip mono">${thb(needTo45)}‡∏ø</span>) ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏π‡πà 35% (‡∏•‡∏î‡∏≠‡∏µ‡∏Å <span class="chip mono">${thb(needTo35)}‡∏ø</span>)`);
            lines.push(`‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏£‡∏ß‡∏°‡∏´‡∏ô‡∏µ‡πâ + ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`);
          }
          return lines;
        })(),
        ef: (()=>{
          const lines=[];
          if(efMonths<3){
            const sug = Math.max(1000, Math.round((needTo3m/6)/100)*100);
            lines.push(`‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ${efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠)`);
            lines.push(`‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏≠‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <span class="chip mono">${thb(sug)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‚Üí ‡πÅ‡∏ï‡∏∞ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î`);
            lines.push(`‡∏´‡∏≤‡∏Å‡πÑ‡∏´‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô ${thb(Math.round((needTo6m/12)/100)*100)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏à‡∏∞‡∏Ñ‡∏£‡∏ö 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô ~12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);
          }else if(efMonths<=6){
            lines.push(`‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á ${efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)`);
            lines.push(`‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö 3‚Äì6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏™‡∏π‡∏á ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏¢‡∏Å‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô`);
          }else{
            const excess = Math.max(0, sav - 6*totalExp);
            lines.push(`‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á ${efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤)`);
            lines.push(`‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ~ <span class="chip mono">${thb(excess)}‡∏ø</span> ‡πÇ‡∏¢‡∏Å‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ (DCA ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`);
          }
          return lines;
        })(),
        liquidity: (()=>{
          const lines=[];
          if(liquidity<0){
            const cutPlan = buildCuts(Math.abs(liquidity));
            lines.push(`‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö <span class="chip mono">${thb(Math.abs(liquidity))}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‚Üí ‡πÅ‡∏ú‡∏ô‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î:`);
            cutPlan.forEach(p=> lines.push(`‚Ä¢ ‡∏•‡∏î ‚Äú${p.label}‚Äù ~${(p.pct*100).toFixed(0)}% ‚âà <span class="chip mono">${thb(p.amount)}‡∏ø</span>/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`));
            if(dti>45) lines.push(`‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏π‡πà: ‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô DTI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á`);
          }else{
            const to6m = Math.max(0, 6*totalExp - sav);
            const efAlloc = Math.min(liquidity, to6m);
            const investAlloc = Math.max(0, liquidity - efAlloc);
            lines.push(`‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ß‡∏Å <span class="chip mono">${thb(liquidity)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‚Üí ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£`);
            lines.push(`‚Ä¢ ‡πÄ‡∏ï‡∏¥‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: <span class="chip mono">${thb(efAlloc)}‡∏ø</span>/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);
            lines.push(`‚Ä¢ ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ (DCA): <span class="chip mono">${thb(investAlloc)}‡∏ø</span>/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);
          }
          return lines;
        })(),
        caps
      };

      userData.results = { inc, debt, spend, totalExp, sav, dti, efMonths, liquidity, dtiStatus, dtiColor, efStatus, efColor, liqStatus, liqColor, needTo35, needTo45, needTo3m, needTo6m, actions, offenders };
      debounce();
      renderAttitude();
    }

    /* ===== Attitude ===== */
    function renderAttitude(){
      $('questionScreen').classList.add('hidden');
      $('attitudeScreen').classList.remove('hidden');
      currentAttitudeQuestion=0; userData.attitudeAnswers=[];
      showAttitudeQ();
    }
    function setProgressAtt(){
      setProgress(questions.length + currentAttitudeQuestion + 1, questions.length + attitudeQuestions.length);
    }
    function showAttitudeQ(){
      const q = attitudeQuestions[currentAttitudeQuestion]; setProgressAtt();
      const opts = q.opts.map((o,i)=>`<button class="btn w-full text-left px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl border-2 border-gray-200 hover:border-indigo-400 font-semibold text-gray-800 shadow-sm" data-ans="${i}">
        <span class="flex items-center gap-3"><span class="text-2xl">‚Ä¢</span><span>${o.t}</span></span></button>`).join('');
      $('attitudeContent').innerHTML = `
        <div class="text-center mb-6">
          <div class="inline-block p-5 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl mb-4"><div class="text-5xl">ü§î</div></div>
          <div class="inline-block px-3 py-1 bg-purple-100 rounded-full mb-3 text-purple-700 text-sm font-bold">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttitudeQuestion+1}/${attitudeQuestions.length}</div>
          <p class="text-xl text-gray-800 font-bold leading-relaxed max-w-lg mx-auto">${q.q}</p>
        </div>
        <div class="grid gap-3">${opts}</div>`;
      $('attitudeContent').querySelectorAll('[data-ans]').forEach(b=> b.onclick=()=>selectAtt(parseInt(b.dataset.ans,10)));
    }
    function selectAtt(i){
      const q=attitudeQuestions[currentAttitudeQuestion], sel=q.opts[i];
      userData.attitudeAnswers.push({q:q.q, a:sel.t, ok:sel.ok});
      currentAttitudeQuestion++;
      if(currentAttitudeQuestion<attitudeQuestions.length) { showAttitudeQ(); }
      else { renderFinal(); }
      buzz();
    }

    /* ===== Final + What-if Simulator ===== */
    function ring(el, pct, color, label, valueText){
      const R=54, C=2*Math.PI*R, p=Math.max(0,Math.min(100,pct));
      el.innerHTML = `
        <div class="p-4 rounded-2xl bg-white/90 border border-white/60 shadow text-center">
          <svg width="140" height="140" viewBox="0 0 140 140" class="mx-auto block">
            <circle cx="70" cy="70" r="${R}" stroke="#e5e7eb" stroke-width="14" fill="none"/>
            <circle cx="70" cy="70" r="${R}" stroke="${color}" stroke-linecap="round" stroke-width="14" fill="none"
              class="ring" style="stroke-dasharray:${C};stroke-dashoffset:${C};transform:rotate(-90deg);transform-origin:50% 50%"/>
            <text x="50%" y="50%" text-anchor="middle" dy="8" font-size="22" font-weight="800" fill="${color}">${valueText}</text>
          </svg>
          <div class="mt-2 font-bold text-gray-800">${label}</div>
        </div>`;
      requestAnimationFrame(()=>{ el.querySelectorAll('circle')[1].style.strokeDashoffset = C*(1 - p/100); });
    }

    function bList(lines){ return `<ul class="list-disc list-inside text-gray-700 leading-relaxed">${lines.map(x=>`<li>${x}</li>`).join('')}</ul>`; }

    function capTable(caps, data){
      const rows = expenseCategories.map(c=>{
        const cap=caps[c.key]||0, now=data.expenses[c.key]||0, diff=cap-now;
        const color = diff>=0?'#10b981':'#ef4444';
        return `<tr class="text-sm">
          <td class="py-2">${c.icon} ${c.label}</td>
          <td class="py-2 text-right mono">${thb(now)}</td>
          <td class="py-2 text-right mono">${thb(cap)}</td>
          <td class="py-2 text-right mono" style="color:${color}">${diff>=0?'+':''}${thb(diff)}</td>
        </tr>`;
      }).join('');
      return `<table class="w-full"><thead>
        <tr class="text-xs text-gray-500 border-b"><th class="py-2 text-left">‡∏´‡∏°‡∏ß‡∏î</th><th class="py-2 text-right">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</th><th class="py-2 text-right">‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th><th class="py-2 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th></tr>
      </thead><tbody>${rows}</tbody></table>`;
    }

    function renderFinal(){
      $('attitudeScreen').classList.add('hidden');
      $('progressContainer').classList.add('hidden');
      $('finalScreen').classList.remove('hidden');

      const R=userData.results, offenders=R.offenders;
      const correct=userData.attitudeAnswers.filter(a=>a.ok).length, total=attitudeQuestions.length;
      const attColor = correct/total>=.8?'#10b981': correct/total>=.6?'#3b82f6':'#f59e0b';
      const ringRow = `<div id="ringRow" class="grid grid-cols-1 sm:grid-cols-3 gap-3 my-4"></div>`;

      $('finalContent').innerHTML = `
        <div class="text-center mb-2">
          <div class="inline-block p-5 bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl mb-3"><div class="text-5xl">‚ú®</div></div>
          <h2 class="text-2xl sm:text-3xl font-extrabold" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">
            ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì
          </h2>
          <p class="text-gray-500">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á</p>
        </div>

        ${ringRow}

        <!-- Cards -->
        <div class="grid gap-4">
          <!-- DTI -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow" style="border-color:${R.dtiColor}">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">DTI</h3>
              <span class="px-3 py-1 text-xs rounded-full text-white" style="background:${R.dtiColor}">${R.dtiStatus}</span>
            </div>
            <div class="text-3xl font-extrabold mb-1" style="color:${R.dtiColor}">${R.dti.toFixed(1)}%</div>
            ${bList(R.actions.dti)}
          </div>

          <!-- EF -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow" style="border-color:${R.efColor}">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h3>
              <span class="px-3 py-1 text-xs rounded-full text-white" style="background:${R.efColor}">${R.efStatus}</span>
            </div>
            <div class="text-3xl font-extrabold mb-1" style="color:${R.efColor}">${R.efMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            ${bList(R.actions.ef)}
          </div>

          <!-- Liquidity -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-5 shadow" style="border-color:${R.liqColor}">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-bold">‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á</h3>
              <span class="px-3 py-1 text-xs rounded-full text-white" style="background:${R.liqColor}">${R.liqStatus}</span>
            </div>
            <div class="text-3xl font-extrabold mb-1" style="color:${R.liqColor}">${thb(R.liquidity)} ‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            ${bList(R.actions.liquidity)}
          </div>

          <!-- Personalized Caps -->
          <div class="bg-white rounded-2xl p-5 border">
            <div class="flex items-center gap-2 mb-2"><span class="text-2xl">üì¶</span><h3 class="text-lg font-bold">‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏∏‡∏ì)</h3></div>
            ${capTable(R.actions.caps, userData)}
          </div>
        </div>

        <!-- What-if Simulator -->
        <div class="bg-white/90 border rounded-2xl p-5 shadow mt-4">
          <div class="flex items-center gap-2 mb-2"><span class="text-2xl">üß™</span><h3 class="text-lg font-bold">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏î (What-if)</h3></div>
          <div class="grid-auto">
            <div>
              <label class="block text-sm font-semibold mb-1">‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ Top 3 ‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</label>
              <input id="simCut" type="range" min="0" max="40" step="1" value="15" class="w-full">
              <div class="text-xs text-gray-600">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="simCutVal" class="mono">15%</span></div>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ/‡πÇ‡∏õ‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <input id="simDebt" type="range" min="0" max="50" step="1" value="10" class="w-full">
              <div class="text-xs text-gray-600">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="simDebtVal" class="mono">10%</span> ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (<span id="simDebtBaht" class="mono"></span>‡∏ø)</div>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">‡∏≠‡∏≠‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <input id="simEF" type="range" min="0" max="30" step="1" value="10" class="w-full">
              <div class="text-xs text-gray-600">‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="simEFVal" class="mono">10%</span> ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (<span id="simEFBaht" class="mono"></span>‡∏ø)</div>
            </div>
          </div>

          <div id="simResult" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4"></div>
          <div id="simAdvice" class="text-sm text-gray-700 leading-relaxed mt-3"></div>
        </div>

        <!-- Actions -->
        <div class="grid gap-3 sm:grid-cols-2 mt-5">
          <button id="btnRestart" class="btn px-6 py-4 rounded-2xl text-white font-bold" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
          <button id="btnShare" class="btn px-6 py-4 rounded-2xl font-semibold bg-white border">üîó ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
        </div>
      `;

      // Rings render
      const row=$('ringRow'); const a=document.createElement('div'), b=document.createElement('div'), c=document.createElement('div'); row.append(a,b,c);
      const dtiPct = Math.max(0, 100 - Math.min(100, R.dti));
      const efPct  = Math.min(100, (R.efMonths/6)*100);
      const liqPct = R.liquidity<=0 ? 0 : Math.min(100, (R.liquidity / (R.inc||1))*100);
      ring(a, dtiPct, R.dtiColor, 'DTI (‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)', `${dtiPct.toFixed(0)}%`);
      ring(b, efPct,  R.efColor, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', `${R.efMonths.toFixed(1)}‡∏î.`);
      ring(c, liqPct, R.liqColor, '‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á/‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', `${liqPct.toFixed(0)}%`);

      // What-if simulator
      const simCut=$('simCut'), simDebt=$('simDebt'), simEF=$('simEF');
      const simCutVal=$('simCutVal'), simDebtVal=$('simDebtVal'), simEFVal=$('simEFVal');
      const simDebtBaht=$('simDebtBaht'), simEFBaht=$('simEFBaht');
      function syncLabels(){
        simCutVal.textContent = simCut.value+'%';
        simDebtVal.textContent = simDebt.value+'%';
        simEFVal.textContent = simEF.value+'%';
        simDebtBaht.textContent = thb(R.inc * (simDebt.value/100));
        simEFBaht.textContent = thb(R.inc * (simEF.value/100));
      }
      function runSim(){
        const cutPct = Number(simCut.value)/100;
        const addDebt = R.inc * (Number(simDebt.value)/100);
        const saveEF  = R.inc * (Number(simEF.value)/100);

        // ‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Top3
        let spendNew = R.spend;
        const top3 = [...R.offenders].slice(0,3);
        top3.forEach(t=> spendNew -= t.v * cutPct);
        spendNew = Math.max(0, spendNew);

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏ô‡∏µ‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÇ‡∏õ‡∏∞)
        const debtNew = Math.max(0, R.debt - addDebt); // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö (‡∏≠‡∏ô‡∏∏‡∏£‡∏±‡∏Å‡∏©‡πå‡∏ô‡∏¥‡∏¢‡∏°)

        const totalNew = spendNew + debtNew;
        const dtiNew = R.inc>0 ? (debtNew/R.inc)*100 : 0;
        const liqNew = R.inc - totalNew - saveEF; // ‡∏Å‡∏±‡∏ô EF ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô
        const efMonthsNew = (R.sav + saveEF)/ (totalNew>0? totalNew:1);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ
        const box = (label,val,sub,color)=>`
          <div class="rounded-xl border p-4 text-center" style="border-color:${color}">
            <div class="text-xs text-gray-500 mb-1">${label}</div>
            <div class="text-2xl font-extrabold mono" style="color:${color}">${val}</div>
            <div class="text-xs text-gray-500 mt-1">${sub}</div>
          </div>`;
        $('simResult').innerHTML = [
          box('DTI ‡πÉ‡∏´‡∏°‡πà', dtiNew.toFixed(1)+'%', `‡∏•‡∏î‡∏•‡∏á ${ (R.dti - dtiNew).toFixed(1) } ‡∏à‡∏∏‡∏î`, '#6366f1'),
          box('‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', efMonthsNew.toFixed(1)+' ‡∏î.', `‡∏™‡∏∞‡∏™‡∏°/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${thb(saveEF)}‡∏ø`, '#10b981'),
          box('‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', `${thb(liqNew)}‡∏ø`, `‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏±‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô ${thb(saveEF)}‡∏ø`, liqNew>=0?'#10b981':'#ef4444')
        ].join('');

        const needTo35New = Math.max(0, (R.inc*0.35) - debtNew < 0 ? (debtNew - R.inc*0.35) : 0);
        const monthsTo3m = R.needTo3m>0 ? Math.ceil(R.needTo3m / Math.max(1, saveEF)) : 0;
        $('simAdvice').innerHTML = `
          <div class="grid-auto mt-2">
            <div class="bg-white rounded-lg p-3 border">
              <div class="font-semibold mb-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ DTI 35%</div>
              ${needTo35New<=0 ? '<div class="text-sm text-green-700">‚úÖ ‡πÅ‡∏ï‡∏∞ ‚â§35% ‡πÅ‡∏•‡πâ‡∏ß</div>' :
               `<div class="text-sm">‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ/‡∏£‡∏µ‡πÑ‡∏ü‡πÅ‡∏ô‡∏ô‡∏ã‡πå‡∏≠‡∏µ‡∏Å <span class="chip mono">${thb(needTo35New)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span></div>`}
            </div>
            <div class="bg-white rounded-lg p-3 border">
              <div class="font-semibold mb-1">‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
              ${R.needTo3m<=0 ? '<div class="text-sm text-green-700">‚úÖ ‡∏Ñ‡∏£‡∏ö ‚â•3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>' :
               saveEF<=0 ? '<div class="text-sm text-amber-700">‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>' :
               `<div class="text-sm">‡∏Ñ‡∏≤‡∏î ~<span class="chip mono">${monthsTo3m} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‡∏´‡∏≤‡∏Å‡∏≠‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ <span class="chip mono">${thb(saveEF)}‡∏ø</span></div>`}
            </div>
            <div class="bg-white rounded-lg p-3 border">
              <div class="font-semibold mb-1">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</div>
              <div class="text-sm">‡∏ï‡∏±‡∏î Top3 ‡∏´‡∏°‡∏ß‡∏î‡∏•‡∏∞ ~<span class="chip mono">${pctFmt(cutPct)}</span> 
              ‚Üí ‡∏£‡∏ß‡∏°‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ~<span class="chip mono">${thb(R.offenders.slice(0,3).reduce((s,x)=>s+x.v*cutPct,0))}‡∏ø</span>/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            </div>
          </div>
        `;
        userData.sim = { cutPct, addDebt, saveEF, dtiNew, efMonthsNew, liqNew };
        debounce();
      }
      syncLabels(); runSim();
      [simCut,simDebt,simEF].forEach(el=> el.addEventListener('input', ()=>{ syncLabels(); runSim(); }));

      $('btnRestart').onclick = ()=>{
        userData = { income:0, debtExpense:0, expenses:{}, savings:0, attitudeAnswers:[] };
        currentStep=0; $('finalScreen').classList.add('hidden'); $('welcomeScreen').classList.remove('hidden'); $('progressBar').style.width='0%'; saveState();
      };
      $('btnShare').onclick = shareResult;
    }

    /* ===== Init ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      const has = loadState();
      const btnStart=document.getElementById('btnStart');
      const btnResume=document.getElementById('btnResume');
      btnStart.onclick = ()=>{ $('progressContainer').classList.remove('hidden'); start(); };
      if(has){ btnResume.classList.remove('hidden'); btnResume.onclick = ()=>{ if(userData.results){ renderFinal(); } else { $('progressContainer').classList.remove('hidden'); start(); } toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß','success'); } }
    });
  </script>
</body>
</html>
