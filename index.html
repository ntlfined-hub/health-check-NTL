<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‚Ä¢ FIN-JOD Style (Detailed Advice)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --from:#0f0c29; --mid:#302b63; --to:#24243e;
      --primary:#667eea; --secondary:#764ba2; --success:#10b981; --warn:#f59e0b; --danger:#ef4444;
    }
    html,body{height:100%}
    body{
      margin:0; padding:0; box-sizing:border-box;
      font-family:'Inter','Noto Sans Thai',system-ui,-apple-system,'Segoe UI',sans-serif;
      background: linear-gradient(135deg, var(--from) 0%, var(--mid) 50%, var(--to) 100%);
    }
    .fade-in{animation:fadeIn .5s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(12px)} to{opacity:1; transform:none}}
    .animate-pulse-slow{animation: pulse 3s cubic-bezier(.4,0,.6,1) infinite}
    @keyframes pulse{0%,100%{opacity:1} 50%{opacity:.8}}
    .gradient-text{
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .glass{ background: rgba(255,255,255,.95); backdrop-filter: blur(16px); border:1px solid rgba(255,255,255,.35) }
    .btn{ position:relative; overflow:hidden; transition:transform .2s ease, box-shadow .2s ease }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(99,102,241,.35) }
    .btn:active{ transform:none }
    .status-badge{ backdrop-filter: blur(8px) }
    .progress-bar{ transition: width .35s cubic-bezier(.4,0,.2,1) }
    @view-transition { navigation: auto; }
    .sr-live{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden }
    input[data-money]{ transition: all .2s ease; background: rgba(249,250,251,.85) }
    input[data-money]:focus{
      background:#fff; box-shadow: 0 8px 18px rgba(99,102,241,.15); transform: translateY(-1px);
      outline: none;
    }
    .advice-list li{ margin-bottom:.45rem }
    .advice-chip{ display:inline-block; padding:.25rem .5rem; border-radius:.5rem; background:#f1f5f9; font-weight:600; }
  </style>
</head>
<body class="min-h-full">
  <!-- Animated blobs -->
  <div class="pointer-events-none select-none">
    <div class="absolute top-20 left-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply blur-3xl opacity-20 animate-pulse-slow"></div>
    <div class="absolute top-40 right-10 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply blur-3xl opacity-20 animate-pulse-slow" style="animation-delay:1s"></div>
    <div class="absolute -bottom-20 left-1/2 w-72 h-72 bg-indigo-500 rounded-full mix-blend-multiply blur-3xl opacity-20 animate-pulse-slow" style="animation-delay:2s"></div>
  </div>

  <div id="ariaLive" class="sr-live" aria-live="polite"></div>

  <main class="relative z-10 min-h-full flex items-center justify-center p-4">
    <div class="w-full max-w-2xl">
      <div id="progressContainer" class="mb-6 hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-white/80 text-sm font-medium">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
          <span id="progressText" class="text-white text-sm font-bold">0%</span>
        </div>
        <div class="bg-white/15 rounded-full h-2 overflow-hidden backdrop-blur">
          <div id="progressBar" class="progress-bar h-2 rounded-full" style="width:0%; background:linear-gradient(90deg,var(--primary),var(--secondary))"></div>
        </div>
      </div>

      <div id="contentContainer" class="glass rounded-3xl shadow-2xl p-8 sm:p-10 fade-in">
        <!-- Welcome -->
        <section id="welcomeScreen">
          <div class="text-center">
            <div class="inline-block p-6 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-3xl mb-6 shadow-2xl">
              <div class="text-6xl">üí∞</div>
            </div>
            <h1 id="mainTitle" class="text-4xl sm:text-5xl font-extrabold mb-3 gradient-text">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
            <p id="subtitle" class="text-gray-500 mb-8 sm:mb-10 text-base sm:text-lg font-medium max-w-md mx-auto">
              ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
            </p>

            <div class="grid gap-3 sm:gap-4">
              <button id="btnStart" class="btn px-6 py-4 sm:px-10 sm:py-5 rounded-2xl text-white font-bold text-base sm:text-lg shadow-xl"
                style="background:linear-gradient(135deg,var(--primary),var(--secondary))">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‚Üí
              </button>
              <button id="btnResume" class="btn px-6 py-4 rounded-2xl font-semibold text-gray-800 bg-white border border-gray-200 hidden">
                ‚ñ∂Ô∏è ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô
              </button>
            </div>
          </div>
        </section>

        <!-- Questions -->
        <section id="questionScreen" class="hidden">
          <div id="questionContent"></div>
        </section>

        <!-- Attitude -->
        <section id="attitudeScreen" class="hidden">
          <div id="attitudeContent"></div>
        </section>

        <!-- Final -->
        <section id="finalScreen" class="hidden">
          <div class="text-center mb-8">
            <div class="text-5xl mb-3">üéØ</div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2" style="color:var(--primary)">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
          </div>
          <div id="finalContent"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Toast root -->
  <div id="toastRoot" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-[9999]"></div>

  <script>
    /* ============== Helpers ============== */
    const fmt = new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 });
    const toBaht = n => fmt.format(Math.round(n||0));
    const ariaLive = (t)=>{ const el=document.getElementById('ariaLive'); el.textContent=t };
    function toast(msg, type='info'){
      const root = document.getElementById('toastRoot');
      const box = document.createElement('div');
      box.className = `px-4 py-3 rounded-xl text-white shadow-lg mb-2`;
      box.style.background = type==='success' ? '#10b981' :
                             type==='warn' ? '#f59e0b' :
                             type==='error'? '#ef4444' : '#6366f1';
      box.textContent = msg;
      root.appendChild(box);
      setTimeout(()=>{ box.style.opacity=.0; box.style.transform='translateY(6px)'; }, 1600);
      setTimeout(()=> box.remove(), 2200);
      ariaLive(msg);
    }
    const buzz = (ms=12)=> (navigator.vibrate && navigator.vibrate(ms));

    function parseMoneyInput(el){
      const raw = el.dataset.raw;
      const v = raw!==undefined ? raw : el.value.replace(/,/g,'').trim();
      const num = parseFloat(v);
      return isNaN(num) ? 0 : num;
    }
    document.addEventListener('input', (e)=>{
      if(e.target.matches('input[data-money]')){
        const cleaned = e.target.value.replace(/[^\d.]/g,'').replace(/(\..*?)\..*/,'$1');
        const num = cleaned===''? '' : cleaned;
        e.target.dataset.raw = num;
        if(num===''){ e.target.value=''; return; }
        const parts = String(num).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        e.target.value = parts.join('.');
      }
    });

    /* ============== Data ============== */
    const defaultConfig = {
      main_title: "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô",
      subtitle: "‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      text_color: "#333333"
    };

    let currentStep = 0, currentAttitudeQuestion = 0;
    let userData = { income:0, debtExpense:0, expenses:{}, savings:0, attitudeAnswers:[] };

    const expenseCategories = [
      { key: 'food', label: '‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£', icon: 'üçú' },
      { key: 'transport', label: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á/‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô', icon: 'üöó' },
      { key: 'household', label: '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô', icon: 'üè†' },
      { key: 'utilities', label: '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü', icon: 'üí°' },
      { key: 'entertainment', label: '‡∏Ñ‡πà‡∏≤‡∏ô‡∏±‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏≤‡∏£/‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå', icon: 'üéâ' },
      { key: 'clothing', label: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', icon: 'üëî' },
      { key: 'internet', label: '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå', icon: 'üì±' },
      { key: 'other', label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon: 'üìù' }
    ];

    const attitudeQuestions = [
      { question:'‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏£‡∏Å?', options:[
          { text:'‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á', correct:true },
          { text:'‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô', correct:false },
          { text:'‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏≠‡∏≠‡∏°', correct:false }
        ], explanation:'‡∏≠‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô (Pay Yourself First) ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á' },
      { question:'‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', options:[
          { text:'‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠', correct:true },
          { text:'‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ', correct:false },
          { text:'‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô', correct:false }
        ], explanation:'‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ä‡∏±‡∏î + ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ = ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏™‡∏π‡∏á' },
      { question:'‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÇ‡∏ö‡∏ô‡∏±‡∏™) ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', options:[
          { text:'‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å', correct:true },
          { text:'‡πÉ‡∏ä‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ', correct:false },
          { text:'‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ä‡πâ ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏≠‡∏°', correct:false }
        ], explanation:'‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á' },
      { question:'‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', options:[
          { text:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', correct:true },
          { text:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡πâ‡∏≤‡∏á', correct:false },
          { text:'‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', correct:false }
        ], explanation:'‚Äú‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‚Äù ‡∏Ñ‡∏∑‡∏≠‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏•' },
      { question:'‡πÄ‡∏à‡∏≠‡πÇ‡∏õ‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?', options:[
          { text:'‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô', correct:true },
          { text:'‡∏£‡∏µ‡∏ö‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°', correct:false },
          { text:'‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô', correct:false }
        ], explanation:'‡∏ñ‡∏π‡∏Å‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô = ‡∏¢‡∏±‡∏á‡πÅ‡∏û‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏≤' }
    ];

    const questions = [
      { id:'income',   title:'‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',      icon:'üíµ', description:'‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single',   field:'income' },
      { id:'debt',     title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',  icon:'üí≥', description:'‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô/‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'single', field:'debtExpense' },
      { id:'expenses', title:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô',    icon:'üõí', description:'‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', type:'multiple', field:'expenses' },
      { id:'savings',  title:'‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô',      icon:'üè¶', description:'‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ', type:'single', field:'savings' }
    ];

    /* ============== Autosave & Deep link ============== */
    const SAVE_KEY='finhealth:v1';
    const qs = new URLSearchParams(location.search);

    function loadState(){
      try{
        if(qs.get('s')){ userData = JSON.parse(decodeURIComponent(atob(qs.get('s')))); return true; }
        const raw = localStorage.getItem(SAVE_KEY);
        if(raw){ userData = JSON.parse(raw); return true; }
      }catch(e){}
      return false;
    }
    function saveState(){
      const minimal = {
        income:userData.income, debtExpense:userData.debtExpense, expenses:userData.expenses,
        savings:userData.savings, attitudeAnswers:userData.attitudeAnswers||[], results:userData.results||null
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(minimal));
    }
    const saveDebounce=(fn=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(fn,350);} })(saveState);

    function shareResult(){
      if(!userData.results){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå','warn'); return; }
      const s = btoa(encodeURIComponent(JSON.stringify(userData)));
      const url = `${location.origin}${location.pathname}?s=${s}`;
      navigator.clipboard?.writeText(url).then(()=> { toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß','success'); buzz(); });
    }

    /* ============== Flow ============== */
    const byId = id => document.getElementById(id);
    function startAssessment(){
      byId('welcomeScreen').classList.add('hidden');
      byId('progressContainer').classList.remove('hidden');
      currentStep=0; showQuestion(); buzz();
    }
    function previousQuestion(){ if(currentStep>0){ currentStep--; showQuestion(); saveDebounce(); } }
    function updateProgress(now,total){ const pct=Math.round((now/total)*100); byId('progressBar').style.width=pct+'%'; byId('progressText').textContent=pct+'%'; }
    function moneyInputHTML(id, placeholder='0'){
      return `<input type="text" id="${id}" data-money class="w-full px-6 py-4 border-0 rounded-2xl text-xl font-semibold text-gray-800" placeholder="${placeholder}" inputmode="decimal" aria-label="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)">`;
    }

    function showQuestion(){
      const qWrap = byId('questionScreen'); qWrap.classList.remove('hidden');
      const host = byId('questionContent');
      const q = questions[currentStep];
      updateProgress(currentStep+1, questions.length + attitudeQuestions.length);

      if(q.type==='single'){
        host.innerHTML = `
          <div class="text-center mb-7">
            <div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4"><div class="text-5xl">${q.icon}</div></div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">${q.title}</h2>
            <p class="text-gray-500 font-medium">${q.description}</p>
          </div>
          <div class="mb-7">
            <label class="block text-sm font-bold mb-2 text-gray-700 uppercase tracking-wide">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
            ${moneyInputHTML('money_single')}
          </div>
          <div class="flex gap-3">
            ${currentStep>0?'<button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl hover:bg-gray-200">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>':''}
            <button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
          </div>`;
        const el = byId('money_single');
        el.value = userData[q.field] ? toBaht(userData[q.field]) : '';
        el.dataset.raw = userData[q.field] || '';
      } else {
        const fields = expenseCategories.map(cat=>`
          <div class="mb-3">
            <label for="ex_${cat.key}" class="block text-sm font-bold mb-2 text-gray-700 flex items-center gap-2">
              <span class="text-2xl">${cat.icon}</span><span>${cat.label}</span>
            </label>
            ${moneyInputHTML(`ex_${cat.key}`)}
          </div>
        `).join('');
        host.innerHTML = `
          <div class="text-center mb-6">
            <div class="inline-block p-5 bg-gradient-to-br from-purple-100 to-indigo-100 rounded-2xl mb-4"><div class="text-5xl">${q.icon}</div></div>
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-gray-800">${q.title}</h2>
            <p class="text-gray-500 font-medium">${q.description}</p>
          </div>
          <div class="max-h-96 overflow-y-auto mb-6 pr-1 space-y-1">${fields}</div>
          <div class="flex gap-3">
            <button id="btnPrev" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl hover:bg-gray-200">‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button id="btnNext" class="btn flex-1 px-6 py-4 text-white font-bold rounded-2xl shadow-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
          </div>`;
        expenseCategories.forEach(cat=>{
          const el = byId(`ex_${cat.key}`);
          const v = userData.expenses[cat.key] || 0;
          if(v){ el.value = toBaht(v); el.dataset.raw = v; }
        });
      }
      const prev = byId('btnPrev'); if(prev) prev.onclick = previousQuestion;
      byId('btnNext').onclick = nextQuestion;
    }

    function nextQuestion(){
      const q = questions[currentStep];
      if(q.type==='single'){
        const val = parseMoneyInput(byId('money_single'));
        if(val<0 || isNaN(val)){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','warn'); return; }
        userData[q.field] = val;
      }else{
        expenseCategories.forEach(cat=>{
          const el = byId(`ex_${cat.key}`); const v = el ? parseMoneyInput(el) : 0;
          userData.expenses[cat.key] = v;
        });
      }
      currentStep++; saveDebounce();
      if(currentStep < questions.length) showQuestion(); else showResults();
      buzz();
    }

    /* ============== Core Calculations + Detailed Advice ============== */
    function showResults(){
      const income = userData.income||0;
      const debt = userData.debtExpense||0;
      const spend = Object.values(userData.expenses||{}).reduce((a,b)=>a+(b||0),0);
      const totalMonthlyExpense = debt + spend;
      const savingsNow = userData.savings||0;

      // DTI
      const dti = income>0 ? (debt/income)*100 : 0;
      let dtiStatus, dtiColor;
      if(dti<=35){ dtiStatus='‡∏î‡∏µ‡∏°‡∏≤‡∏Å'; dtiColor= '#10b981'; }
      else if(dti<=45){ dtiStatus='‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á'; dtiColor='#f59e0b'; }
      else{ dtiStatus='‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢'; dtiColor='#ef4444'; }
      const targetDTI35 = Math.max(0, (income*0.35));
      const needReduceTo35 = Math.max(0, debt - targetDTI35);
      const targetDTI45 = Math.max(0, (income*0.45));
      const needReduceTo45 = Math.max(0, debt - targetDTI45);

      // EF
      const emergencyMonths = totalMonthlyExpense>0 ? savingsNow/totalMonthlyExpense : 0;
      let efStatus, efColor;
      if(emergencyMonths<3){ efStatus='‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠'; efColor='#ef4444'; }
      else if(emergencyMonths<=6){ efStatus='‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠'; efColor='#10b981'; }
      else{ efStatus='‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤'; efColor='#3b82f6'; }
      const needTo3m = Math.max(0, (3*totalMonthlyExpense) - savingsNow);
      const needTo6m = Math.max(0, (6*totalMonthlyExpense) - savingsNow);

      // Liquidity
      const liquidity = income - totalMonthlyExpense;
      let liqStatus, liqColor;
      if(liquidity<0){ liqStatus='‡∏ï‡∏¥‡∏î‡∏•‡∏ö'; liqColor='#ef4444'; }
      else{ liqStatus='‡∏î‡∏µ'; liqColor='#10b981'; }

      // Top 3 spend categories (for advice)
      const top3 = Object.entries(userData.expenses||{})
        .map(([k,v])=>({k,v, label:(expenseCategories.find(c=>c.key===k)||{}).label||k}))
        .sort((a,b)=>b.v-a.v).slice(0,3).filter(x=>x.v>0);

      // Build detailed advice text blocks (rich, data-driven)
      const dtiAdvice = (() => {
        if(dti<=35){
          return [
            `DTI ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${dti.toFixed(1)}% (‡∏î‡∏µ‡∏°‡∏≤‡∏Å) ‚Äî ‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏Å‡∏î‡∏î‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î`,
            `‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏±‡∏ô‡∏á‡∏ö ‚Äú‡∏≠‡∏≠‡∏°/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‚Äù ‚âà <span class="advice-chip">${toBaht(income*0.20)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>`,
            `‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏™‡∏π‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ <strong>Avalanche</strong> (‡∏õ‡∏¥‡∏î‡∏î‡∏≠‡∏Å‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°`
          ];
        }else if(dti<=45){
          return [
            `DTI = ${dti.toFixed(1)}% (‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á) ‚Äî ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 35%`,
            `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚â§ <span class="advice-chip">${toBaht(targetDTI35)}‡∏ø</span> (‡∏•‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <span class="advice-chip">${toBaht(needReduceTo35)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>)`,
            `‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î, ‡πÇ‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏ï‡πà‡∏≥, ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ DTI < 35%`
          ];
        }else{
          return [
            `DTI = ${dti.toFixed(1)}% (‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢) ‚Äî ‡∏†‡∏≤‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô`,
            `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô: ‡∏•‡∏î‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 45% (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <span class="advice-chip">${toBaht(needReduceTo45)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤ 35% ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (<span class="advice-chip">${toBaht(needReduceTo35)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>)`,
            `‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ/‡∏£‡∏ß‡∏°‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏ï‡πà‡∏≥, ‡∏¢‡∏∑‡∏î‡∏á‡∏ß‡∏î, ‡πÄ‡∏£‡∏¥‡πà‡∏° <strong>Debt Snowball</strong> (‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à) + ‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`
          ];
        }
      })();

      const efAdvice = (() => {
        if(emergencyMonths<3){
          return [
            `‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô = ${emergencyMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠)`,
            `‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3‚Äì6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏Ç‡∏≤‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ ~ <span class="advice-chip">${toBaht(needTo3m)}‡∏ø</span> (‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏Å 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`,
            `‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥: <strong>‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10‚Äì20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</strong> ‚âà <span class="advice-chip">${toBaht(income*0.15)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏ï‡πà‡πÑ‡∏õ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å ${toBaht(needTo6m)}‡∏ø ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`
          ];
        }else if(emergencyMonths<=6){
          return [
            `‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô = ${emergencyMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)`,
            `‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö 3‚Äì6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡πÇ‡∏î‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏´‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏™‡∏π‡∏á/‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏π‡∏á`,
            `‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ï‡∏∞ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏¢‡∏Å‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ`
          ];
        }else{
          const excess = Math.max(0, savingsNow - 6*totalMonthlyExpense);
          return [
            `‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô = ${emergencyMonths.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏õ‡πâ‡∏≤)`,
            `‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô ~ <span class="advice-chip">${toBaht(excess)}‡∏ø</span> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô‡∏î‡∏±‡∏ä‡∏ô‡∏µ/‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏£‡∏´‡∏ô‡∏µ‡πâ) ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
            `‡∏Ñ‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÑ‡∏ß‡πâ ~6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢`
          ];
        }
      })();

      const liqAdvice = (() => {
        if(liquidity<0){
          const gap = Math.abs(liquidity);
          const cuts = top3.map((e,i)=> `${i+1}. ${e.label} ‡∏•‡∏î 15% ‚âà <span class="advice-chip">${toBaht(e.v*0.15)}‡∏ø</span>` ).join(' ‚Ä¢ ');
          return [
            `‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏•‡∏ö <span class="advice-chip">${toBaht(gap)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>`,
            top3.length ? `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ: ${cuts}` : `‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô 10‚Äì20% ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß`,
            dti>45 ? `‡πÄ‡∏û‡∏£‡∏≤‡∏∞ DTI ‡∏™‡∏π‡∏á ‚Äî ‡πÉ‡∏´‡πâ ‚Äú‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1 ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢` : `‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏© + ‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏π‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÄ‡∏ô‡πá‡∏ï/‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏°‡∏¥‡πà‡∏á)`
          ];
        }else{
          const bucketEF = Math.min(liquidity, Math.max(0, (6*totalMonthlyExpense) - savingsNow)); // ‡∏Å‡∏±‡∏ô‡πÑ‡∏õ EF ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 6m
          const bucketInvest = Math.max(0, liquidity - bucketEF);
          return [
            `‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ß‡∏Å: <span class="advice-chip">${toBaht(liquidity)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>`,
            `‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‚ë† ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (~<span class="advice-chip">${toBaht(bucketEF)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>) ‚ë° ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏á‡∏ó‡∏∏‡∏ô (~<span class="advice-chip">${toBaht(bucketInvest)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>)`,
            dti>35 ? `‡∏ñ‡πâ‡∏≤ DTI > 35% ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÑ‡∏õ ‚Äú‡πÇ‡∏õ‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏™‡∏π‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î DTI ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô` : `‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏≠‡∏≠‡∏°‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ (DCA) ‡πÅ‡∏•‡∏∞‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ó‡∏∏‡∏Å 6‚Äì12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`
          ];
        }
      })();

      // Store results
      userData.results = {
        dti:{ value:dti, status:dtiStatus, color:dtiColor, adviceLines:dtiAdvice },
        emergencyFund:{ value:emergencyMonths, status:efStatus, color:efColor, adviceLines:efAdvice },
        liquidity:{ value:liquidity, status:liqStatus, color:liqColor, adviceLines:liqAdvice },
        meta:{ income, debt, spend, totalMonthlyExpense, savingsNow, needTo3m, needTo6m }
      };
      saveDebounce();
      startAttitudeTest();
    }

    /* ============== Attitude ============== */
    function startAttitudeTest(){
      byId('questionScreen').classList.add('hidden');
      byId('attitudeScreen').classList.remove('hidden');
      currentAttitudeQuestion = 0; userData.attitudeAnswers = []; showAttitudeQuestion();
    }
    function showAttitudeQuestion(){
      const host = byId('attitudeContent');
      const q = attitudeQuestions[currentAttitudeQuestion];
      updateProgress(questions.length + currentAttitudeQuestion + 1, questions.length + attitudeQuestions.length);
      const shuffled = q.options.map((o,i)=>({o,i})).sort(()=>Math.random()-0.5);
      host.innerHTML = `
        <div class="text-center mb-7">
          <div class="inline-block p-5 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl mb-4"><div class="text-5xl">ü§î</div></div>
          <div class="inline-block px-3 py-1 bg-purple-100 rounded-full mb-3 text-purple-700 text-sm font-bold">
            ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttitudeQuestion+1} / ${attitudeQuestions.length}
          </div>
          <p class="text-xl text-gray-800 font-bold leading-relaxed max-w-lg mx-auto">${q.question}</p>
        </div>
        <div class="space-y-3">
          ${shuffled.map(({o,i})=>`
            <button class="btn w-full text-left px-6 py-5 bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl hover:from-purple-50 hover:to-indigo-50 border-2 border-gray-200 hover:border-purple-400 transition-all font-semibold text-gray-800 shadow-sm" data-ans="${i}">
              <span class="flex items-center gap-3"><span class="text-2xl">‚Ä¢</span><span>${o.text}</span></span>
            </button>`).join('')}
        </div>`;
      host.querySelectorAll('button[data-ans]').forEach(btn=>{
        btn.onclick = ()=> selectAttitudeAnswer(parseInt(btn.dataset.ans,10));
      });
    }
    function selectAttitudeAnswer(answerIndex){
      const q = attitudeQuestions[currentAttitudeQuestion], sel = q.options[answerIndex];
      userData.attitudeAnswers.push({ question:q.question, answer:sel.text, correct:sel.correct });
      const host = byId('attitudeContent');
      const ok = sel.correct, bg = ok?'#d1fae5':'#fee2e2', bd = ok?'#10b981':'#ef4444', tx=ok?'#065f46':'#991b1b', icon = ok?'‚úÖ':'‚ùå';
      toast(ok?'‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å!':'‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤', ok?'success':'warn'); buzz();
      host.innerHTML = `
        <div class="text-center mb-8">
          <div class="inline-block p-6 rounded-3xl mb-5 shadow-xl" style="background:${bg}"><div class="text-6xl">${icon}</div></div>
          <div class="inline-block px-3 py-1 bg-purple-100 rounded-full mb-3 text-purple-700 text-sm font-bold">
            ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttitudeQuestion+1} / ${attitudeQuestions.length}
          </div>
          <p class="text-lg text-gray-700 font-bold mb-5 max-w-lg mx-auto">${q.question}</p>
          <div class="p-5 rounded-2xl mb-6 shadow-lg" style="background:${bg}; border:3px solid ${bd}"><p class="font-bold text-lg" style="color:${tx}">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${sel.text}</p></div>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6 shadow-md">
          <div class="flex items-center gap-2 mb-2"><span class="text-2xl">üí°</span><h3 class="font-bold text-lg text-blue-900">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</h3></div>
          <p class="text-gray-700 leading-relaxed font-medium">${q.explanation}</p>
        </div>
        <button id="btnNextAtt" class="btn w-full px-6 py-5 text-white font-bold rounded-2xl shadow-xl text-lg" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">
          ${currentAttitudeQuestion < attitudeQuestions.length-1 ? '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí' : '‡∏î‡∏π‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ üéØ'}
        </button>`;
      byId('btnNextAtt').onclick = nextAttitudeQuestion;
      saveDebounce();
    }
    function nextAttitudeQuestion(){
      currentAttitudeQuestion++;
      if(currentAttitudeQuestion < attitudeQuestions.length) showAttitudeQuestion(); else showFinalResults();
      buzz();
    }

    /* ============== Final & Rings (with Detailed Sections) ============== */
    function ring(el, pct, color, label, valueText){
      const R = 54, C = 2*Math.PI*R, p = Math.max(0, Math.min(100, pct));
      el.innerHTML = `
        <div class="p-4 rounded-2xl bg-white/90 border border-white/60 shadow text-center">
          <svg width="140" height="140" viewBox="0 0 140 140" class="mx-auto block">
            <circle cx="70" cy="70" r="${R}" stroke="#e5e7eb" stroke-width="14" fill="none"/>
            <circle cx="70" cy="70" r="${R}" stroke="${color}" stroke-linecap="round"
                    stroke-width="14" fill="none"
                    style="stroke-dasharray:${C};stroke-dashoffset:${C};transform:rotate(-90deg);transform-origin:50% 50%;transition:stroke-dashoffset .9s cubic-bezier(.2,.8,.2,1)"/>
            <text x="50%" y="50%" text-anchor="middle" dy="8" font-size="22" font-weight="800" fill="${color}">${valueText}</text>
          </svg>
          <div class="mt-2 font-bold text-gray-800">${label}</div>
        </div>`;
      requestAnimationFrame(()=>{ const bar = el.querySelectorAll('circle')[1]; bar.style.strokeDashoffset = C*(1 - p/100); });
    }

    function listHTML(lines){
      return `<ul class="advice-list list-disc list-inside text-gray-700 leading-relaxed">
        ${lines.map(x=>`<li>${x}</li>`).join('')}
      </ul>`;
    }

    function quickWinsHTML(d, meta, top3){
      const wins = [];
      // Win 1: ‡∏ñ‡πâ‡∏≤ EF < 3m ‚Üí ‡∏≠‡∏≠‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      if(d.emergencyFund.value < 3){
        const suggest = Math.max(1000, Math.round((meta.needTo3m/6)/100)*100); // ‡πÅ‡∏ô‡∏∞‡∏ä‡∏≥‡∏£‡∏∞/‡∏≠‡∏≠‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏±‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏•‡∏∞ 100
        wins.push(`‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏≠‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ <span class="advice-chip">${toBaht(suggest)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‚Üí ‡πÅ‡∏ï‡∏∞ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î`);
      }
      // Win 2: ‡∏ñ‡πâ‡∏≤ DTI > 35 ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏™‡∏π‡∏á
      if(d.dti.value > 35){
        const boost = Math.max(500, Math.round((meta.income*0.05)/100)*100);
        wins.push(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î ‚Äú‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‚Äù ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <span class="advice-chip">${toBaht(boost)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> (‡∏•‡∏î‡∏î‡∏≠‡∏Å‡∏™‡∏∞‡∏™‡∏°)`);
      }
      // Win 3: ‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ Top1 10‚Äì15%
      if(top3.length){
        const cut = Math.round(top3[0].v*0.15/100)*100;
        wins.push(`‡∏•‡∏î ‚Äú${top3[0].label}‚Äù ‡∏•‡∏á ~15% ‚âà <span class="advice-chip">${toBaht(cut)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span> ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ`);
      }
      return listHTML(wins.length?wins:[
        '‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡∏° 20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äú‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô/‡∏•‡∏á‡∏ó‡∏∏‡∏ô‚Äù',
        '‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡∏ú‡∏π‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÄ‡∏ô‡πá‡∏ï/‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏°‡∏¥‡πà‡∏á) ‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏¢‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏ß‡πà‡∏≤',
        '‡∏´‡∏¢‡∏∏‡∏î‡∏ú‡πà‡∏≠‡∏ô 0% ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤ DTI < 35%'
      ]);
    }

    function plan306090HTML(d, meta){
      // ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤: 30 ‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏•‡∏î‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•/‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏≠‡∏°, 60 ‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ, 90 ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡πà‡∏á‡∏•‡∏á‡∏ó‡∏∏‡∏ô/‡πÇ‡∏õ‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
      const m = meta;
      const p30 = [
        `‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏≠‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ${toBaht(Math.max(1000, Math.round((m.income*0.10)/100)*100))}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ)`,
        `‡∏à‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏£‡∏±‡πà‡∏ß 3 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å`,
        d.dti.value>45 ? `‡∏ô‡∏±‡∏î‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠ <strong>‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏µ‡πâ</strong> / ‡πÇ‡∏≠‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡∏ï‡πà‡∏≥` : `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (envelope)`,
      ];
      const p60 = [
        d.dti.value>35 ? `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏î‡∏≠‡∏Å‡πÅ‡∏û‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏µ‡∏Å ${toBaht(Math.round((m.income*0.05)/100)*100)}‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô` : `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô ‚â•15% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ`,
        `‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏∞ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏≤‡∏î ~${toBaht(m.needTo3m)}‡∏ø)`,
        `‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏) ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡πÄ‡∏´‡∏°‡∏≤‡∏∞`
      ];
      const p90 = [
        d.emergencyFund.value<6 ? `‡πÑ‡∏ï‡πà‡∏à‡∏≤‡∏Å 3 ‚Üí 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏Ç‡∏≤‡∏î ~${toBaht(m.needTo6m)}‡∏ø) ‡πÇ‡∏î‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏á‡∏ó‡∏µ‡πà` :
          `‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÇ‡∏¢‡∏Å‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÅ‡∏ö‡∏ö DCA ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`,
        d.dti.value>35 ? `‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤ DTI < 35% ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 6‚Äì12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÇ‡∏õ‡∏∞‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà` : `‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏µ‡∏•‡∏∞ 1‚Äì2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`,
        `‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô/‡∏ó‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`
      ];
      return `
        <div class="grid gap-4 sm:grid-cols-3">
          <div class="bg-white rounded-xl border border-gray-100 p-4 shadow">
            <h4 class="font-bold text-gray-800 mb-2">30 ‡∏ß‡∏±‡∏ô</h4>${listHTML(p30)}
          </div>
          <div class="bg-white rounded-xl border border-gray-100 p-4 shadow">
            <h4 class="font-bold text-gray-800 mb-2">60 ‡∏ß‡∏±‡∏ô</h4>${listHTML(p60)}
          </div>
          <div class="bg-white rounded-xl border border-gray-100 p-4 shadow">
            <h4 class="font-bold text-gray-800 mb-2">90 ‡∏ß‡∏±‡∏ô</h4>${listHTML(p90)}
          </div>
        </div>`;
    }

    function showFinalResults(){
      byId('attitudeScreen').classList.add('hidden');
      byId('progressContainer').classList.add('hidden');
      byId('finalScreen').classList.remove('hidden');

      const correct = userData.attitudeAnswers.filter(a=>a.correct).length;
      const total = attitudeQuestions.length;
      const score = (correct/total)*100;
      let attLevel, attColor, attMsg;
      if(score>=80){ attLevel='‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'; attColor= '#10b981'; attMsg='‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á'; }
      else if(score>=60){ attLevel='‡∏î‡∏µ'; attColor='#3b82f6'; attMsg='‡∏î‡∏µ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÑ‡∏î‡πâ'; }
      else { attLevel='‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'; attColor='#f59e0b'; attMsg='‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢/‡∏≠‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô'; }

      const d = userData.results;
      const meta = d.meta;
      const top3 = Object.entries(userData.expenses||{})
        .map(([k,v])=>({k,v, label:(expenseCategories.find(c=>c.key===k)||{}).label||k}))
        .sort((a,b)=>b.v-a.v).slice(0,3).filter(x=>x.v>0);

      const host = byId('finalContent');
      host.innerHTML = `
        <div class="text-center mb-6">
          <div class="inline-block p-5 bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl mb-4"><div class="text-5xl">‚ú®</div></div>
          <h3 class="text-2xl sm:text-3xl font-extrabold mb-2 gradient-text">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
          <p class="text-gray-500 font-medium">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô + ‡∏ó‡∏±‡∏®‡∏Ñ‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</p>
        </div>

        <div id="ringRow" class="grid grid-cols-1 sm:grid-cols-3 gap-3 my-6"></div>

        <!-- Cards (‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤ + ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î) -->
        <div class="space-y-4">
          <!-- DTI -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-6 shadow" style="border-color:${d.dti.color}">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-lg font-bold text-gray-800">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (DTI)</h4>
              <span class="status-badge px-3 py-1 rounded-full text-white text-xs font-bold" style="background:${d.dti.color}">${d.dti.status}</span>
            </div>
            <div class="text-3xl font-extrabold mb-2" style="color:${d.dti.color}">${d.dti.value.toFixed(1)}%</div>
            ${listHTML(d.dti.adviceLines)}
          </div>

          <!-- EF -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-6 shadow" style="border-color:${d.emergencyFund.color}">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-lg font-bold text-gray-800">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h4>
              <span class="status-badge px-3 py-1 rounded-full text-white text-xs font-bold" style="background:${d.emergencyFund.color}">${d.emergencyFund.status}</span>
            </div>
            <div class="text-3xl font-extrabold mb-2" style="color:${d.emergencyFund.color}">${d.emergencyFund.value.toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            ${listHTML(d.emergencyFund.adviceLines)}
          </div>

          <!-- Liquidity -->
          <div class="bg-gradient-to-br from-white to-gray-50 border-l-4 rounded-2xl p-6 shadow" style="border-color:${d.liquidity.color}">
            <div class="flex items-center justify-between mb-3">
              <h4 class="text-lg font-bold text-gray-800">‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h4>
              <span class="status-badge px-3 py-1 rounded-full text-white text-xs font-bold" style="background:${d.liquidity.color}">${d.liquidity.status}</span>
            </div>
            <div class="text-3xl font-extrabold mb-2" style="color:${d.liquidity.color}">${toBaht(d.liquidity.value)} ‡∏ø/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            ${listHTML(d.liquidity.adviceLines)}
          </div>
        </div>

        <!-- Quick Wins -->
        <div class="bg-white/90 border border-gray-100 rounded-2xl p-6 shadow mt-6">
          <div class="flex items-center gap-2 mb-3"><span class="text-2xl">‚ö°</span><h4 class="text-xl font-bold text-gray-800">‡∏ó‡∏≥‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (Quick Wins)</h4></div>
          ${quickWinsHTML(d, meta, top3)}
        </div>

        <!-- 30/60/90 Plan -->
        <div class="bg-white/90 border border-gray-100 rounded-2xl p-6 shadow mt-4">
          <div class="flex items-center gap-2 mb-3"><span class="text-2xl">üóìÔ∏è</span><h4 class="text-xl font-bold text-gray-800">‡πÅ‡∏ú‡∏ô 30 / 60 / 90 ‡∏ß‡∏±‡∏ô</h4></div>
          ${plan306090HTML(d, meta)}
        </div>

        <!-- Attitude -->
        <div class="bg-gradient-to-br from-white to-gray-50 border rounded-2xl p-6 shadow mt-6">
          <div class="text-center">
            <div class="inline-block p-4 rounded-2xl mb-3" style="background:${attColor}20"><div class="text-5xl">üéØ</div></div>
            <h4 class="text-2xl font-bold mb-2" style="color:${attColor}">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏±‡∏®‡∏Ñ‡∏ï‡∏¥: ${attLevel}</h4>
            <div class="text-4xl font-extrabold mb-2" style="color:${attColor}">${correct}/${total}</div>
            <p class="text-gray-600">${attMsg}</p>
          </div>
        </div>

        <div class="grid gap-3 sm:grid-cols-2 mt-6">
          <button id="btnRestart" class="btn px-6 py-4 rounded-2xl text-white font-bold" style="background:linear-gradient(135deg,var(--primary),var(--secondary))">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
          <button id="btnShare" class="btn px-6 py-4 rounded-2xl font-semibold bg-white border border-gray-200">üîó ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
        </div>
      `;

      // Rings
      const row = byId('ringRow');
      const a = document.createElement('div'), b = document.createElement('div'), c = document.createElement('div');
      row.append(a,b,c);
      const dtiPct = Math.max(0, 100 - Math.min(100, d.dti.value));
      const efPct  = Math.min(100, (d.emergencyFund.value/6)*100);
      const liqPct = d.liquidity.value<=0 ? 0 : Math.min(100, (d.liquidity.value / (meta.income||1))*100);
      ring(a, dtiPct, d.dti.color, 'DTI (‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏µ)', `${dtiPct.toFixed(0)}%`);
      ring(b, efPct,  d.emergencyFund.color, '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô', `${d.emergencyFund.value.toFixed(1)}‡∏î.`);
      ring(c, liqPct, d.liquidity.color, '‡∏™‡∏†‡∏≤‡∏û‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', `${liqPct.toFixed(0)}%`);

      byId('btnRestart').onclick = restartAssessment;
      byId('btnShare').onclick = shareResult;

      saveDebounce();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function restartAssessment(){
      currentStep = 0; currentAttitudeQuestion = 0;
      userData = { income:0, debtExpense:0, expenses:{}, savings:0, attitudeAnswers:[], results:null };
      byId('finalScreen').classList.add('hidden');
      byId('welcomeScreen').classList.remove('hidden');
      byId('progressContainer').classList.add('hidden');
      byId('progressBar').style.width='0%';
      saveDebounce();
    }

    /* ============== Init ============== */
    document.addEventListener('DOMContentLoaded', ()=>{
      byId('mainTitle').textContent = defaultConfig.main_title;
      byId('subtitle').textContent  = defaultConfig.subtitle;

      const hasState = loadState();
      const btnStart = byId('btnStart');
      const btnResume = byId('btnResume');
      btnStart.onclick = startAssessment;

      if(hasState){
        btnResume.classList.remove('hidden');
        btnResume.onclick = ()=>{
          if(userData.results){ byId('welcomeScreen').classList.add('hidden'); showFinalResults(); }
          else { startAssessment(); }
          toast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß','success');
        };
      }
    });
  </script>
</body>
</html>
